<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Exclusive Layer — Sistema Multichain PREMIUM IDENTITY com RPC Infra Identity</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Cinzel:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/exclusivelayer2/assets/css/style.css">

</head>
<body class="theme-luxury">
  <div class="wallet-container">
    <header>
      <div class="logo">
        <h1>Exclusive Layer</h1>
        <span>Multichain PREMIUM IDENTITY</span>
        <div style="margin-top: 10px;">
          <div class="status-indicator verified" style="display: inline-block; margin-right: 8px;"></div>
          <span style="font-size: 11px; color: var(--success-color); letter-spacing: 1px;">SISTEMA PREMIUM ATIVO</span>
        </div>
      </div>
      <div class="theme-controls">
        <button class="theme-toggle-btn" id="themeToggle"><i class="fas fa-sun"></i> Modo Claro</button>
      </div>
    </header>

    <!-- ÁREA DE LOGIN -->
    <div id="login-screen">
      <div class="wallet-header">
        <h2>Sistema Polygon Premium Identity</h2>
        <p>Identidade única Polygon para gerenciamento completo e acesso a recursos premium.</p>
        <div style="margin-top: 20px;">
          <div class="communication-badge unlocked" style="display: inline-flex; margin: 5px; background: transparent; color: var(--primary-color);">
            <i class="fas fa-shield-alt" style="color: var(--primary-color);"></i> 100% Client-Side
          </div>
          <div class="communication-badge unlocked" style="display: inline-flex; margin: 5px; background: transparent; color: var(--primary-color);">
            <i class="fas fa-lock" style="color: var(--primary-color);"></i> Criptografia Ponta a Ponta
          </div>
          <div class="communication-badge unlocked" style="display: inline-flex; margin: 5px; background: transparent; color: var(--primary-color);">
            <i class="fas fa-server" style="color: var(--primary-color);"></i> RPC Infra Identity
          </div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="info-card animate-element">
          <h3><i class="fas fa-key"></i> Acesso com Chave Privada</h3>
          <div class="input-group">
            <label for="privateKey">Sua Chave Privada Polygon</label>
            <input type="password" id="privateKey" placeholder="0x..." style="font-family: 'Courier New', monospace;">
          </div>
          <button class="btn btn-primary" id="loginPrivateKey">
            <i class="fas fa-unlock"></i> Conectar Carteira
          </button>
          <button class="restore-mnemonic-btn" id="restoreMnemonicLogin">
            <i class="fas fa-redo"></i> Usar Frase Mnemônica
          </button>
        </div>

        <div class="info-card animate-element delay-1">
          <h3><i class="fas fa-plus-circle"></i> Nova Carteira Polygon</h3>
          <div class="input-group">
            <label for="newWalletPassword">Senha de Segurança (Opcional)</label>
            <input type="password" id="newWalletPassword" placeholder="Proteja sua carteira localmente">
            <small style="color:var(--text-secondary);font-size:11px;margin-top:5px">
              <i class="fas fa-exclamation-triangle"></i> Senha local apenas neste dispositivo. Se perdida, use a chave privada.
            </small>
          </div>
          <button class="btn btn-primary" id="createWallet">
            <i class="fas fa-gem"></i> Criar Nova Carteira Polygon
          </button>
          <button class="restore-mnemonic-btn" id="restoreMnemonicNew">
            <i class="fas fa-redo"></i> Restaurar com Mnemônica
          </button>
        </div>
      </div>

      <div class="balance-container animate-element delay-2">
        <div class="balance-label">Identidade Principal</div>
        <div class="balance-display">Polygon Network</div>
        <div class="balance-label" style="margin-top: 20px; font-size: 14px;">
          RPC Infra Identity • Polygon ID • Endereço Único • QR Code Único
        </div>
        <div style="margin-top: 25px; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
          <div style="text-align: center;">
            <div style="font-size: 20px; font-weight: 600; color: var(--primary-color);">20</div>
            <div style="font-size: 11px; color: var(--text-secondary);">Blockchains</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 20px; font-weight: 600; color: var(--primary-color);">6</div>
            <div style="font-size: 11px; color: var(--text-secondary);">Recursos Premium</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 20px; font-weight: 600; color: var(--success-color);">∞</div>
            <div style="font-size: 11px; color: var(--text-secondary);">Conexões</div>
          </div>
        </div>
      </div>

      <div class="info-card animate-element delay-2">
        <h3><i class="fas fa-shield-alt"></i> Segurança Premium</h3>
        <p style="margin-bottom: 25px; color: var(--text-secondary); font-size: 15px; line-height: 1.6;">
          Protocolo de comunicação criptografado de ponta a ponta. Suas chaves nunca saem do seu dispositivo.
          Sistema multichain com suporte a 20 blockchains diferentes.
        </p>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <button class="btn btn-secondary btn-small" onclick="showSecurityInfoModal()">
            <i class="fas fa-info-circle"></i> Informações Técnicas
          </button>
          <button class="btn btn-secondary btn-small" onclick="showRecoveryBox()">
            <i class="fas fa-key"></i> Protocolo de Recuperação
          </button>
        </div>
      </div>
    </div>

    <!-- DASHBOARD PRINCIPAL -->
    <div id="wallet-dashboard" class="hidden">
      <div class="wallet-header">
        <h2>Dashboard Polygon Identity</h2>
        <p>Identidade única Polygon com gestão completa e recursos premium</p>
        <div style="margin-top: 20px;">
          <div class="status-indicator verified" style="display: inline-block; margin-right: 8px;"></div>
          <span style="font-size: 12px; color: var(--success-color); letter-spacing: 1px;">
            CONECTADO VIA RPC INFRA IDENTITY • 
            <span id="connectionStatus">LATÊNCIA: --</span>
          </span>
        </div>
      </div>

      <!-- Navegação Principal Refinada -->
      <div class="tab-navigation">
        <button class="tab-button active" data-tab="overviewTab">
          <i class="fas fa-home"></i> Visão Geral
        </button>
        <button class="tab-button" data-tab="walletTab">
          <i class="fas fa-wallet"></i> Wallet
        </button>
        <button class="tab-button" data-tab="blockchainsTab">
          <i class="fas fa-link"></i> Blockchains
        </button>
        <button class="tab-button" data-tab="authorizationsTab">
          <i class="fas fa-user-shield"></i> Autorizações
        </button>
        <button class="tab-button" data-tab="infraIdentityTab">
          <i class="fas fa-server"></i> Infra Identity
        </button>
        <button class="tab-button" data-tab="securityTab">
          <i class="fas fa-shield-alt"></i> Segurança
        </button>
        <button class="tab-button" data-tab="agendaTab">
          <i class="fas fa-calendar"></i> Agenda
        </button>
        <button class="tab-button" data-tab="communicationTab">
          <i class="fas fa-comments"></i> Comunicação
        </button>
      </div>

      <!-- Overview Tab -->
      <div class="tab-content active" id="overviewTab">
        <div class="info-card">
          <h3><i class="fas fa-chart-pie"></i> Visão Geral da Identidade Polygon</h3>
          <p style="margin-bottom: 25px; color: var(--text-secondary); font-size: 15px; line-height: 1.6;">
            Status completo do seu protocolo de comunicação e recursos disponíveis.
          </p>
          
          <div class="balance-container" style="margin: 20px 0;">
            <div class="balance-label">Endereço Público Polygon</div>
            <div class="balance-display" id="walletAddressDisplay" style="font-size: 36px;">0x0ba3...9DaC7f</div>
            <div class="balance-label">Protocolo de Comunicação Premium</div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px;">
            <div style="text-align: center; padding: 15px; background: var(--gradient-card); border-radius: 12px;">
              <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">Status</div>
              <div style="font-size: 20px; font-weight: 600; color: var(--success-color);" id="walletStatus">Ativo</div>
            </div>
            <div style="text-align: center; padding: 15px; background: var(--gradient-card); border-radius: 12px;">
              <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">Recursos</div>
              <div style="font-size: 20px; font-weight: 600; color: var(--primary-color);" id="featureCount">6</div>
            </div>
            <div style="text-align: center; padding: 15px; background: var(--gradient-card); border-radius: 12px;">
              <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">Segurança</div>
              <div style="font-size: 20px; font-weight: 600; color: var(--primary-color);" id="securityLevel">Máxima</div>
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 10px; margin: 30px 0; flex-wrap: wrap; justify-content: center;">
          <button class="btn btn-secondary btn-small" onclick="switchTab('walletTab')">
            <i class="fas fa-wallet"></i> Wallet Polygon
          </button>
          <button class="btn btn-secondary btn-small" onclick="switchTab('blockchainsTab')">
            <i class="fas fa-link"></i> Multichain
          </button>
          <button class="btn btn-secondary btn-small" onclick="switchTab('infraIdentityTab')">
            <i class="fas fa-server"></i> Infra Identity
          </button>
          <button class="btn btn-secondary btn-small" onclick="switchTab('communicationTab')">
            <i class="fas fa-comments"></i> Comunicação
          </button>
        </div>

        <div class="address-registration-box" id="addressRegistrationBox">
          <h3 class="address-registration-title">
            <i class="fas fa-broadcast-tower"></i> Registro de Identidade Polygon
          </h3>
          
          <p class="address-instruction">
            Para liberar o acesso aos recursos de comunicação, registre seu endereço Polygon abaixo.
          </p>
          
          <div class="wallet-address-display">
            <div class="address-text" id="publicAddressDisplay" style="font-size: 12px;">0x0ba3F2f891A90547C171727E745CeA6ad69DaC7f</div>
            <button class="copy-btn" onclick="copyAddress()">
              <i class="fas fa-copy"></i> Copiar
            </button>
          </div>
          
          <div class="input-group">
            <label for="confirmAddressCheckbox" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="confirmAddressCheckbox">
              Confirmo que este é meu endereço Polygon principal
            </label>
          </div>
          
          <button class="btn btn-secondary" id="registerAddressBtn" disabled><i class="fas fa-check"></i> Registrar Identidade</button>
          
          <div class="verification-status">
            <div class="status-indicator" id="statusIndicator" style="background: var(--text-secondary);"></div>
            <span id="statusText" style="color: var(--text-secondary); font-size: 13px;">Identidade não registrada</span>
          </div>
          
          <div class="communication-badges" id="communicationBadges">
            <div class="communication-badge unlocked">
              <i class="fas fa-user-friends"></i> Contatos
            </div>
            <div class="communication-badge unlocked">
              <i class="fas fa-comment"></i> Chat
            </div>
            <div class="communication-badge unlocked">
              <i class="fas fa-video"></i> Vídeo
            </div>
            <div class="communication-badge unlocked">
              <i class="fas fa-users"></i> Grupos
            </div>
          </div>
          
          <p style="text-align: center; color: var(--text-secondary); font-size: 11px; margin-top: 25px;">
            <i class="fas fa-info-circle"></i> Após o registro, sua identidade Polygon será usada como identificador principal.
          </p>
        </div>
      </div>

      <!-- Wallet Tab -->
      <div class="tab-content" id="walletTab">
        <div class="wallet-header">
          <h2><i class="fas fa-wallet"></i> Wallet Polygon Premium</h2>
          <p>Gerencie seus fundos na Polygon com elegância minimalista e funcionalidades completas</p>
        </div>
        
        <div class="wallet-main-container">
          <!-- Container Central de Saldo -->
          <div class="balance-main-container">
            <div class="balance-label">Saldo na Polygon Network</div>
            <div class="balance-display" id="currentChainBalance">0.00</div>
            <div class="balance-label">MATIC</div>
            <div style="font-size: 14px; color: var(--text-secondary); margin-top: 15px;" id="currentChainValue">
              ≈ $0.00 USD
            </div>
            <div class="balance-label" style="margin-top: 20px; font-size: 12px;">
              Conectado via: <span id="rpcConnectionStatus" style="color: var(--success-color);">Infra Identity RPC</span>
            </div>
          </div>
          
          <!-- Botões de Ação -->
          <div class="wallet-operations-grid">
            <div class="action-btn" onclick="showReceiveModal()">
              <i class="fas fa-qrcode"></i>
              <span>Receber</span>
            </div>
            <div class="action-btn" onclick="showSendModal()">
              <i class="fas fa-paper-plane"></i>
              <span>Enviar</span>
            </div>
            <div class="action-btn" onclick="refreshBalance()">
              <i class="fas fa-sync-alt"></i>
              <span>Atualizar</span>
            </div>
          </div>
          
          <!-- QR Code Container -->
          <div id="qrCodeContainer" style="display: none; text-align: center; margin: 30px 0;">
            <h4 style="color: var(--primary-color); margin-bottom: 15px; font-family: 'Cinzel', serif; font-size: 18px;">
              <i class="fas fa-qrcode"></i> QR Code para Recebimento
            </h4>
            <div class="qr-container" id="qrCodeCanvas"></div>
            <div class="address-display" style="margin: 20px auto; max-width: 500px; font-size: 12px;" id="qrAddressDisplay">
              <!-- Endereço será inserido aqui -->
            </div>
            <button class="btn btn-secondary btn-small" onclick="copyQRAddress()">
              <i class="fas fa-copy"></i> Copiar Endereço
            </button>
            <button class="btn btn-secondary btn-small" onclick="downloadQRCodeAsCard()" style="margin-left: 10px;">
              <i class="fas fa-download"></i> Salvar QR Code como Cartão de Luxo
            </button>
            <div style="font-size: 9px; color: var(--text-secondary); margin-top: 10px; font-style: italic;">
              este qrcode foi gerado através da licença vitalícia da AVZ Identity
            </div>
          </div>
          
          <!-- Formulário de Envio -->
          <div id="sendFormContainer" style="display: none; margin-top: 30px;">
            <h4 style="color: var(--primary-color); margin-bottom: 15px; font-family: 'Cinzel', serif; font-size: 18px;">
              <i class="fas fa-paper-plane"></i> Enviar Fundos na Polygon
            </h4>
            
            <div class="input-group">
              <label for="sendToAddress">Endereço de Destino</label>
              <input type="text" id="sendToAddress" placeholder="0x..." style="font-family: 'Courier New', monospace;">
            </div>
            
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
              <div class="input-group">
                <label for="sendAmount">Quantidade (MATIC)</label>
                <input type="number" id="sendAmount" placeholder="0.0" step="0.000001" min="0">
              </div>
              <div class="input-group">
                <label for="sendCurrency">Token</label>
                <select id="sendCurrency" style="padding: 18px 15px;">
                  <option value="native">MATIC (Nativo)</option>
                  <option value="usdc">USDC</option>
                  <option value="usdt">USDT</option>
                </select>
              </div>
            </div>
            
            <div class="input-group">
              <label for="gasPrice">Preço do Gás (GWEI)</label>
              <input type="number" id="gasPrice" value="30" step="1" min="1">
              <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">
                Custo estimado: <span id="estimatedGasCost">$0.15</span>
              </div>
            </div>
            
            <div class="form-row" style="justify-content: center; margin-top: 20px;">
              <button class="btn btn-secondary btn-small" onclick="estimateGas()">
                <i class="fas fa-calculator"></i> Estimar Gás
              </button>
              <button class="btn btn-primary btn-small" onclick="sendTransaction()">
                <i class="fas fa-rocket"></i> Enviar Transação
              </button>
              <button class="btn btn-secondary btn-small" onclick="cancelSend()">
                <i class="fas fa-times"></i> Cancelar
              </button>
            </div>
          </div>
          
          <!-- Histórico de Transações -->
          <div style="margin-top: 40px;">
            <h4 style="color: var(--primary-color); margin-bottom: 15px; font-family: 'Cinzel', serif; font-size: 18px;">
              <i class="fas fa-history"></i> Histórico de Transações Polygon
            </h4>
            
            <div id="transactionHistory">
              <div class="tx-history-item">
                <div class="tx-info">
                  <div class="tx-icon tx-in">
                    <i class="fas fa-arrow-down"></i>
                  </div>
                  <div>
                    <div style="font-weight: 500;">Recebimento</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">0x7f5...c3a • há 2 horas</div>
                  </div>
                </div>
                <div class="tx-amount">+1.5 MATIC</div>
              </div>
              
              <div class="tx-history-item">
                <div class="tx-info">
                  <div class="tx-icon tx-out">
                    <i class="fas fa-arrow-up"></i>
                  </div>
                  <div>
                    <div style="font-weight: 500;">Envio</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">0x9b2...f8e • há 1 dia</div>
                  </div>
                </div>
                <div class="tx-amount">-0.8 MATIC</div>
              </div>
            </div>
            
            <button class="btn btn-secondary btn-small" onclick="loadMoreTransactions()" style="width: 100%; margin-top: 15px;">
              <i class="fas fa-redo"></i> Carregar Mais Transações
            </button>
          </div>

          <!-- ===== NOVA SEÇÃO DE TOKENS ===== -->
          <div class="tokens-section">
            <!-- Formulário para adicionar token manualmente -->
            <div class="info-card animate-element">
              <h3><i class="fas fa-plus-circle"></i> Adicionar Token</h3>
              <div class="input-group">
                <label for="manualTokenAddress">Endereço do Contrato</label>
                <input type="text" id="manualTokenAddress" placeholder="0x..." style="font-family: 'Courier New', monospace;">
              </div>
              <div class="input-group">
                <label for="manualTokenSymbol">Símbolo do Token</label>
                <input type="text" id="manualTokenSymbol" placeholder="EX: USDT, LINK...">
              </div>
              <button class="btn btn-primary" id="addManualToken">
                <i class="fas fa-plus"></i> Adicionar ao Portfólio
              </button>
            </div>

            <!-- Linha divisória de luxo -->
            <div class="tokens-divider"></div>

            <!-- Grade de Tokens -->
            <div class="tokens-grid" id="tokensGrid">
              <div class="token-card-luxury">
                <div class="token-card-header">
                  <div class="token-symbol-luxury">USDC</div>
                  <div class="token-icon-luxury">USD</div>
                </div>
                <div class="token-balance-luxury">0.000000</div>
                <div class="token-value-luxury">USD Coin</div>
                <div class="token-value-brl">R$ 0.00</div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 10px; word-break: break-all;">
                  0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174
                </div>
                <div class="token-actions-luxury">
                  <button class="btn btn-secondary btn-small" onclick="transferToken('0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174', 'USDC', 6)">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                  <button class="btn btn-secondary btn-small" onclick="refreshTokenBalance('0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174')">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                  <button class="token-remove-btn-luxury" onclick="removeToken('0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174')">
                    <i class="fas fa-trash"></i> Remover Token
                  </button>
                </div>
              </div>
            
              <div class="token-card-luxury">
                <div class="token-card-header">
                  <div class="token-symbol-luxury">AVZ</div>
                  <div class="token-icon-luxury">AVZ</div>
                </div>
                <div class="token-balance-luxury">69981992872999.460938</div>
                <div class="token-value-luxury">AVZ</div>
                <div class="token-value-brl">R$ 545859544409395.81</div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 10px; word-break: break-all;">
                  0xcE20F7cb738aA5Cf32441B2ba0EFBA1E6f42c0b4
                </div>
                <div class="token-actions-luxury">
                  <button class="btn btn-secondary btn-small" onclick="transferToken('0xcE20F7cb738aA5Cf32441B2ba0EFBA1E6f42c0b4', 'AVZ', 18)">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                  <button class="btn btn-secondary btn-small" onclick="refreshTokenBalance('0xcE20F7cb738aA5Cf32441B2ba0EFBA1E6f42c0b4')">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                  <button class="token-remove-btn-luxury" onclick="removeToken('0xcE20F7cb738aA5Cf32441B2ba0EFBA1E6f42c0b4')">
                    <i class="fas fa-trash"></i> Remover Token
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- ===== FIM DA NOVA SEÇÃO DE TOKENS ===== -->
          
        </div>
      </div>

      <!-- Blockchains Tab -->
      <div class="tab-content" id="blockchainsTab">
        <div class="wallet-header">
          <h2><i class="fas fa-link"></i> Sistema Multichain Premium</h2>
          <p>Gerencie 20 blockchains diferentes com uma única interface premium</p>
        </div>

        <!-- Área superior - 20 botões de blockchains -->
        <div class="blockchain-buttons-container" id="blockchainButtonsContainer">
          <!-- Botões serão inseridos via JavaScript -->
        </div>

        <!-- Linha divisória de luxo -->
        <div class="blockchain-divider"></div>

        <!-- Área inferior totalmente vazia -->
        <div class="blockchain-empty-area">
          <i class="fas fa-gem" style="font-size: 48px; color: var(--primary-color); margin-bottom: 20px;"></i>
          <div style="font-size: 16px; color: var(--text-primary); margin-bottom: 10px;">Selecione uma blockchain acima</div>
          <div style="font-size: 13px; color: var(--text-secondary); max-width: 400px;">
            Gerencie wallets em 20 blockchains diferentes com a mesma elegância e segurança premium
          </div>
        </div>
      </div>

      <!-- Autorizações Tab -->
      <div class="tab-content authorizations-tab" id="authorizationsTab">
        <div class="wallet-header">
          <h2><i class="fas fa-user-shield"></i> Sistema de Autorizações</h2>
          <p>Gerencie permissões e acessos de todas as suas wallets blockchain</p>
        </div>

        <div class="info-card">
          <h3><i class="fas fa-key"></i> Autorizações Ativas</h3>
          <p style="margin-bottom: 25px; color: var(--text-secondary); font-size: 15px; line-height: 1.6;">
            Visualize e gerencie todas as autorizações concedidas às suas wallets.
          </p>
          
          <div class="authorizations-list" id="authorizationsList">
            <div class="authorization-card">
              <div class="authorization-header">
                <div class="authorization-title">Polygon Mainnet</div>
                <div class="authorization-status status-authorized">Autorizado</div>
              </div>
              <div class="authorization-details">
                Wallet: 0x0ba3...9DaC7f<br>
                Data: 24/12/2025<br>
                Permissões: Leitura, Escrita, Contratos
              </div>
              <div class="authorization-actions">
                <button class="btn btn-secondary btn-small">
                  <i class="fas fa-eye"></i> Detalhes
                </button>
                <button class="btn btn-secondary btn-small">
                  <i class="fas fa-times"></i> Revogar
                </button>
              </div>
            </div>
            
            <div class="authorization-card">
              <div class="authorization-header">
                <div class="authorization-title">Ethereum Mainnet</div>
                <div class="authorization-status status-pending">Pendente</div>
              </div>
              <div class="authorization-details">
                Wallet: 0x8f9e...b4c2<br>
                Data: 23/12/2025<br>
                Permissões: Leitura, Transações
              </div>
              <div class="authorization-actions">
                <button class="btn btn-secondary btn-small">
                  <i class="fas fa-eye"></i> Detalhes
                </button>
                <button class="btn btn-secondary btn-small">
                  <i class="fas fa-check"></i> Autorizar
                </button>
              </div>
            </div>
            
            <div class="authorization-card">
              <div class="authorization-header">
                <div class="authorization-title">Binance Smart Chain</div>
                <div class="authorization-status status-authorized">Autorizado</div>
              </div>
              <div class="authorization-details">
                Wallet: 0x3c7a...f9d1<br>
                Data: 22/12/2025<br>
                Permissões: Leitura, Staking
              </div>
              <div class="authorization-actions">
                <button class="btn btn-secondary btn-small">
                  <i class="fas fa-eye"></i> Detalhes
                </button>
                <button class="btn btn-secondary btn-small">
                  <i class="fas fa-times"></i> Revogar
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="info-card">
          <h3><i class="fas fa-shield-alt"></i> Segurança das Autorizações</h3>
          <p style="margin-bottom: 25px; color: var(--text-secondary); font-size: 15px; line-height: 1.6;">
            Todas as autorizações são criptografadas e armazenadas localmente.
          </p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
            <div style="text-align: center; background: var(--gradient-card); padding: 20px; border-radius: 12px;">
              <div style="color: var(--text-secondary); margin-bottom: 15px; font-size: 12px;">
                <i class="fas fa-lock" style="color: var(--success-color); font-size: 24px;"></i>
              </div>
              <div style="font-weight: 600; color: var(--success-color);">Criptografia Local</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Chaves nunca saem do dispositivo</div>
            </div>
            
            <div style="text-align: center; background: var(--gradient-card); padding: 20px; border-radius: 12px;">
              <div style="color: var(--text-secondary); margin-bottom: 15px; font-size: 12px;">
                <i class="fas fa-clock" style="color: var(--primary-color); font-size: 24px;"></i>
              </div>
              <div style="font-weight: 600; color: var(--primary-color);">Validade Limitada</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Expiração automática</div>
            </div>
          </div>
          
          <div class="form-row" style="justify-content: center;">
            <button class="btn btn-primary btn-small" onclick="requestNewAuthorization()">
              <i class="fas fa-plus"></i> Nova Autorização
            </button>
            <button class="btn btn-secondary btn-small" onclick="revokeAllAuthorizations()">
              <i class="fas fa-times"></i> Revogar Todas
            </button>
            <button class="btn btn-secondary btn-small" onclick="exportAuthorizations()">
              <i class="fas fa-download"></i> Exportar
            </button>
          </div>
        </div>
      </div>

      <!-- Infra Identity Tab -->
      <div class="tab-content" id="infraIdentityTab">
        <div class="wallet-header">
          <h2><i class="fas fa-server"></i> Infraestrutura Identity - RPC Polygon</h2>
          <p>Conexão otimizada com a Polygon Network via RPC público popular</p>
        </div>

        <div class="info-card">
          <h3><i class="fas fa-network-wired"></i> Configuração de RPC</h3>
          <p style="margin-bottom: 25px; color: var(--text-secondary); font-size: 15px; line-height: 1.6;">
            Sua wallet está conectada ao RPC público mais popular da Polygon para máxima confiabilidade e performance.
          </p>
          
          <div class="chain-details">
            <div>
              <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 5px;">RPC URL</div>
              <div style="font-size: 14px; font-weight: 500; color: var(--text-primary); font-family: 'Courier New', monospace;" id="currentRpcUrl">
                https://polygon-rpc.com
              </div>
            </div>
            
            <div>
              <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 5px;">Chain ID</div>
              <div style="font-size: 18px; font-weight: 600; color: var(--primary-color);">137</div>
            </div>
            
            <div>
              <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 5px;">Símbolo</div>
              <div style="font-size: 18px; font-weight: 600; color: var(--primary-color);">MATIC</div>
            </div>
            
            <div>
              <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 5px;">Status</div>
              <div style="font-size: 14px; font-weight: 500; color: var(--success-color);" id="rpcStatus">
                <i class="fas fa-check-circle"></i> Conectado
              </div>
            </div>
          </div>
          
          <div style="margin-top: 30px;">
            <h5 style="color: var(--primary-color); margin-bottom: 15px; font-size: 16px;">
              <i class="fas fa-tachometer-alt"></i> Métricas de Performance
            </h5>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
              <div style="text-align: center; background: var(--gradient-card); padding: 15px; border-radius: 12px;">
                <div style="color: var(--text-secondary); font-size: 11px;">Latência</div>
                <div style="font-size: 20px; font-weight: 600; color: var(--success-color);" id="rpcLatency">142ms</div>
              </div>
              
              <div style="text-align: center; background: var(--gradient-card); padding: 15px;border-radius: 12px;">
                <div style="color: var(--text-secondary); font-size: 11px;">Último Bloco</div>
                <div style="font-size: 20px; font-weight: 600; color: var(--primary-color);" id="lastBlock">45,289,127</div>
              </div>
              
              <div style="text-align: center; background: var(--gradient-card); padding: 15px;border-radius: 12px;">
                <div style="color: var(--text-secondary); font-size: 11px;">Preço do Gás</div>
                <div style="font-size: 20px; font-weight: 600; color: var(--primary-color);" id="gasPriceDisplay">30 GWEI</div>
              </div>
            </div>
          </div>
          
          <div style="margin-top: 30px;">
            <h5 style="color: var(--primary-color); margin-bottom: 15px; font-size: 16px;">
              <i class="fas fa-exchange-alt"></i> Conexão Wallet
            </h5>
            
            <div class="input-group">
              <label for="rpcProviderSelect">Provedor RPC</label>
              <select id="rpcProviderSelect" style="padding: 18px 15px;">
                <option value="https://polygon-rpc.com" selected>RPC Público Polygon (Recomendado)</option>
                <option value="https://identitydynamic.avizaecosystem.workers.dev">Identity Dynamic RPC (Premium)</option>
                <option value="https://rpc-mainnet.maticvigil.com">MaticVigil RPC</option>
                <option value="https://polygon-mainnet.infura.io/v3/">Infura RPC</option>
                <option value="https://matic-mainnet.chainstacklabs.com">Chainstack RPC</option>
              </select>
            </div>
            
            <div style="margin: 20px 0; padding: 15px; background: rgba(212, 175, 55, 0.05); border-radius: 10px; border: 1px solid rgba(212, 175, 55, 0.2);">
              <h6 style="color: var(--primary-color); margin-bottom: 10px; font-size: 14px;">
                <i class="fas fa-shield-alt"></i> Identity Dynamic - RPC Autorizado
              </h6>
              <p style="color: var(--text-secondary); font-size: 12px; line-height: 1.5;">
                O RPC Identity Dynamic requer autorização de wallet via assinatura digital.
                Esta proteção garante acesso exclusivo e seguro à infraestrutura premium.
              </p>
              <button class="btn btn-secondary btn-small" onclick="showIdentityAuthorizationInfo()" style="margin-top: 10px;">
                <i class="fas fa-info-circle"></i> Ver Detalhes de Autorização
              </button>
            </div>
            
            <div class="form-row" style="justify-content: center;">
              <button class="btn btn-primary btn-small" onclick="testRpcConnection()">
                <i class="fas fa-plug"></i> Testar Conexão
              </button>
              <button class="btn btn-secondary btn-small" onclick="updateRpcProvider()">
                <i class="fas fa-sync-alt"></i> Atualizar RPC
              </button>
              <button class="btn btn-secondary btn-small" onclick="showRpcInfo()">
                <i class="fas fa-info-circle"></i> Informações
              </button>
            </div>
          </div>
        </div>

        <div class="info-card">
          <h3><i class="fas fa-chart-line"></i> Status da Rede Polygon</h3>
          <p style="margin-bottom: 20px; color: var(--text-secondary);">
            Monitoramento em tempo real da saúde da rede Polygon.
          </p>
          
          <div style="background: var(--gradient-card); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
              <div class="status-indicator verified" style="width: 16px; height: 16px;"></div>
              <div>
                <div style="font-weight: 600; color: var(--success-color);">Rede Polygon Operacional</div>
                <div style="font-size: 13px; color: var(--text-secondary);">Todas as funções disponíveis</div>
              </div>
            </div>
            
            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--card-border);">
              <i class="fas fa-info-circle"></i> Esta infraestrutura garante:
              <ul style="margin-top: 8px; padding-left: 20px;">
                <li>Conexão estável com a Polygon Mainnet</li>
                <li>Estimativa de gás precisa</li>
                <li>Execução rápida de transações</li>
                <li>Suporte a contratos inteligentes</li>
                <li>Consulta de saldo em tempo real</li>
              </ul>
            </div>
          </div>
          
          <div class="form-row" style="justify-content: center;">
            <button class="btn btn-primary btn-small" onclick="refreshNetworkStatus()">
              <i class="fas fa-redo"></i> Atualizar Status
            </button>
            <button class="btn btn-secondary btn-small" onclick="showNetworkMetrics()">
              <i class="fas fa-chart-bar"></i> Ver Métricas
            </button>
            <button class="btn btn-secondary btn-small" onclick="testIdentityDynamicConnection()">
              <i class="fas fa-bolt"></i> Testar Identity Dynamic
            </button>
          </div>
        </div>
        
        <div class="info-card">
          <h3><i class="fas fa-shield-alt"></i> Segurança da Conexão</h3>
          <p style="margin-bottom: 20px; color: var(--text-secondary);">
            Todas as conexões são criptografadas e seguras.
          </p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
            <div style="text-align: center; background: var(--gradient-card); padding: 20px; border-radius: 12px;">
              <div style="color: var(--text-secondary); margin-bottom: 15px; font-size: 12px;">
                <i class="fas fa-lock" style="color: var(--success-color); font-size: 24px;"></i>
              </div>
              <div style="font-weight: 600; color: var(--success-color);">Criptografia TLS/SSL</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Conexão segura</div>
            </div>
            
            <div style="text-align: center; background: var(--gradient-card); padding: 20px; border-radius: 12px;">
              <div style="color: var(--text-secondary); margin-bottom: 15px; font-size: 12px;">
                <i class="fas fa-user-shield" style="color: var(--primary-color); font-size: 24px;"></i>
              </div>
              <div style="font-weight: 600; color: var(--primary-color);">100% Client-Side</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Chaves locais</div>
            </div>

            <div style="text-align: center; background: var(--gradient-card); padding: 20px; border-radius: 12px;">
              <div style="color: var(--text-secondary); margin-bottom: 15px; font-size: 12px;">
                <i class="fas fa-key" style="color: var(--accent-color); font-size: 24px;"></i>
              </div>
              <div style="font-weight: 600; color: var(--accent-color);">Assinatura Identity</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Autorização dinâmica</div>
            </div>

            <div style="text-align: center; background: var(--gradient-card); padding: 20px; border-radius: 12px;">
              <div style="color: var(--text-secondary); margin-bottom: 15px; font-size: 12px;">
                <i class="fas fa-tachometer-alt" style="color: var(--sapphire); font-size: 24px;"></i>
              </div>
              <div style="font-weight: 600; color: var(--sapphire);">Performance</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Otimizado para Polygon</div>
            </div>
          </div>
          
          <p style="text-align: center; color: var(--text-secondary); font-size: 11px; margin-top: 20px;">
            <i class="fas fa-exclamation-triangle"></i> Suas chaves privadas nunca saem do seu dispositivo. 
            A conexão RPC é apenas para consulta e envio de transações.
          </p>
        </div>
      </div>

      <!-- Security Tab -->
      <div class="tab-content" id="securityTab">
        <div class="wallet-header">
          <h2><i class="fas fa-shield-alt"></i> Central de Segurança Premium</h2>
          <p>Proteja seus ativos com as melhores práticas de segurança na Polygon</p>
        </div>

        <div class="dashboard-grid">
          <div class="info-card">
            <h3><i class="fas fa-key"></i> Chave Privada Polygon</h3>
            <p>Sua chave mestra para acessar e recuperar sua identidade Polygon.</p>
            <ul>
              <li><strong>✓ Como usar:</strong> Salve em local seguro e nunca compartilhe.</li>
              <li><strong>⚠ Perigo:</strong> Quem tem essa chave tem acesso TOTAL aos seus fundos.</li>
            </ul>
          </div>

          <div class="info-card">
            <h3><i class="fas fa-lock"></i> Senha de Criptografia</h3>
            <p>Protege sua carteira localmente no seu dispositivo.</p>
            <ul>
              <li><strong>✓ Funcionamento:</strong> A senha criptografa sua carteira apenas neste dispositivo.</li>
              <li><strong>⚠ Atenção:</strong> Se esquecer a senha, use a chave privada para recuperar o acesso.</li>
            </ul>
          </div>

          <div class="info-card">
            <h3><i class="fas fa-shield-alt"></i> 100% Client-Side</h3>
            <p>Tudo acontece no seu dispositivo. Suas chaves nunca saem do seu controle.</p>
            <ul>
              <li><strong>✓ Vantagem:</strong> Sem intermediários. Você é o único dono das suas chaves.</li>
              <li><strong>⚠ Responsabilidade:</strong> Não há "esqueci minha senha". Sua segurança depende de você.</li>
            </ul>
          </div>

          <div class="info-card">
            <h3><i class="fas fa-archive"></i> Backup Polygon Identity</h3>
            <p>Prepare-se para imprevistos com backups seguros.</p>
            <ul>
              <li><strong>✓ Melhor prática:</strong> Guarde múltiplas cópias da chave privada em locais físicos diferentes.</li>
              <li><strong>⚠ Atenção:</strong> Perdeu a chave privada = perda permanente dos fundos.</li>
            </ul>
          </div>
        </div>

        <div class="info-card">
          <h3><i class="fas fa-user-secret"></i> Informações Sensíveis</h3>
          
          <div style="margin-bottom: 25px;">
            <div style="color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">Chave Privada Polygon</div>
            <div id="privateKeyDisplay" class="address-display" style="background: rgba(224, 17, 95, 0.08); border-color: rgba(224, 17, 95, 0.2);">••••••••••••••••••••••••••••••••••••••••••••••</div>
            <div class="form-row">
              <button class="btn btn-secondary btn-small" id="togglePrivateKey"><i class="fas fa-eye"></i> Mostrar Chave</button>
              <button class="btn btn-secondary btn-small" id="copyPrivateKey">
                <i class="fas fa-copy"></i> Copiar Chave
              </button>
            </div>
          </div>

          <div>
            <div style="color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">Frase de Recuperação (12 palavras)</div>
            <div id="mnemonicDisplay" class="address-display" style="background: rgba(212, 175, 55, 0.08); min-height: 60px; display: flex; align-items: center; justify-content: center;">••••••••••••••••••••••••••••••••••••••••••••••</div>
            <div class="form-row">
              <button class="btn btn-secondary btn-small" id="toggleMnemonic"><i class="fas fa-eye"></i> Mostrar Frase</button>
              <button class="btn btn-secondary btn-small" id="copyMnemonic">
                <i class="fas fa-copy"></i> Copiar Frase
              </button>
            </div>
          </div>
        </div>

        <div class="info-card">
          <h3><i class="fas fa-shield-alt"></i> Segurança e Registro</h3>
          
          <div class="form-row">
            <button class="btn btn-secondary btn-small" id="showPrivateKey">
              <i class="fas fa-eye"></i> Ver Chave
            </button>
            <button class="btn btn-secondary btn-small" id="exportWallet">
              <i class="fas fa-download"></i> Exportar
            </button>
            <button class="btn btn-secondary btn-small" id="disconnectWallet">
              <i class="fas fa-sign-out-alt"></i> Sair
            </button>
          </div>
        </div>
      </div>

      <!-- Agenda Tab -->
      <div class="tab-content" id="agendaTab">
        <div class="wallet-header">
          <h2><i class="fas fa-calendar"></i> Agenda Premium</h2>
          <p>Gerencie seus compromissos, reuniões e eventos importantes com elegância minimalista</p>
        </div>

        <div class="info-card">
          <h3><i class="fas fa-calendar-alt"></i> Agenda Premium</h3>
          <p style="margin-bottom: 25px; color: var(--text-secondary); font-size: 15px; line-height: 1.6;">
            Gerencie seus compromissos, reuniões e eventos importantes.
          </p>
          
          <div class="agenda-container">
            <div class="agenda-header">
              <div class="agenda-month-nav">
                <button class="btn btn-secondary btn-small" id="prevMonth">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <div class="agenda-month-title" id="currentMonth">dezembro de 2025</div>
                <button class="btn btn-secondary btn-small" id="nextMonth">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            </div>
            
            <div class="agenda-calendar" id="calendarGrid"></div>
            
            <div class="agenda-event-form">
              <div class="input-group">
                <label for="eventTitle">Título do Evento</label>
                <input type="text" id="eventTitle" placeholder="Ex: Reunião com Investidores">
              </div>
              <div class="input-group">
                <label for="eventDate">Data</label>
                <input type="date" id="eventDate">
              </div>
              <div class="input-group">
                <label for="eventTime">Horário</label>
                <input type="time" id="eventTime">
              </div>
              <div class="input-group">
                <label for="eventDescription">Descrição</label>
                <textarea id="eventDescription" rows="2" placeholder="Detalhes do evento"></textarea>
              </div>
              <button class="btn btn-primary" id="addEvent">
                <i class="fas fa-plus"></i> Adicionar Evento
              </button>
              <button class="btn btn-secondary" id="exportPDF" style="margin-top: 15px;">
                <i class="fas fa-file-pdf"></i> Exportar Agenda (PDF)
              </button>
            </div>
          </div>
          
          <div id="upcomingEvents" style="margin-top: 30px;">
            <h4 style="color: var(--primary-color); margin-bottom: 15px; font-family: 'Cinzel', serif;">Próximos Eventos</h4>
            <div id="eventsList"></div>
          </div>
        </div>
      </div>

      <!-- Communication Tab -->
      <div class="tab-content" id="communicationTab">
        <div class="wallet-header">
          <h2><i class="fas fa-comments"></i> Sistema de Comunicação Premium</h2>
          <p>Comunicação criptografada ponto-a-ponto via Polygon Network</p>
        </div>

        <!-- Sub-navegação da aba de comunicação -->
        <div class="sub-tab-navigation">
          <button class="sub-tab-btn active" data-subtab="authTab">
            <i class="fas fa-key"></i> Autorização
          </button>
          <button class="sub-tab-btn" data-subtab="contactsTab">
            <i class="fas fa-users"></i> Contatos
          </button>
          <button class="sub-tab-btn" data-subtab="chatTab">
            <i class="fas fa-comment"></i> Chat Privado
          </button>
          <button class="sub-tab-btn" data-subtab="videoTab">
            <i class="fas fa-video"></i> Vídeo Chamada
          </button>
          <button class="sub-tab-btn" data-subtab="groupTab">
            <i class="fas fa-comments"></i> Grupos
          </button>
          <button class="sub-tab-btn" data-subtab="groupVideoTab">
            <i class="fas fa-video"></i> Vídeo em Grupo
          </button>
        </div>

        <!-- Sub-aba: Autorização -->
        <div class="sub-tab-content" id="authTab">
          <div class="authorization-box">
            <h3 class="address-registration-title">
              <i class="fas fa-user-shield"></i> Autorização de Acesso
            </h3>
            
            <p class="address-instruction">
              Para acessar o sistema de comunicação, você precisa autorizar seu endereço Polygon.
              Esta autorização garante que apenas você pode usar seus recursos de comunicação.
            </p>
            
            <div class="input-group">
              <label for="authWalletAddress">Seu Endereço Polygon para Autorização</label>
              <input type="text" id="authWalletAddress" placeholder="0x..." style="font-family: 'Courier New', monospace;">
            </div>
            
            <div class="verification-status">
              <div class="status-indicator" id="authStatusIndicator" style="background: var(--text-secondary);"></div>
              <span id="authStatusText" style="color: var(--text-secondary); font-size: 13px;">Não autorizado</span>
            </div>
            
            <button class="btn btn-primary" onclick="authorizeChatAccess()">
              <i class="fas fa-check"></i> Autorizar Acesso
            </button>
            
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--card-border);">
              <p style="color: var(--text-secondary); font-size: 12px; line-height: 1.5;">
                <i class="fas fa-info-circle"></i> A autorização vincula seu endereço Polygon ao sistema de comunicação.
                Você pode adicionar contatos, iniciar chats e chamadas de vídeo apenas com endereços autorizados.
              </p>
            </div>
          </div>
        </div>

        <!-- Sub-aba: Contatos -->
        <div class="sub-tab-content hidden" id="contactsTab">
          <div class="communication-main-container">
            <h3 class="address-registration-title">
              <i class="fas fa-address-book"></i> Gerenciamento de Contatos
            </h3>
            
            <p class="address-instruction">
              Gerencie seus contatos Polygon para comunicação rápida e segura.
            </p>
            
            <!-- Lista de contatos -->
            <div class="contacts-list-container" id="contactsList">
              <!-- Contatos serão carregados aqui -->
            </div>
            
            <!-- Formulário para adicionar novo contato -->
            <div class="add-contact-form">
              <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 16px;">
                <i class="fas fa-user-plus"></i> Adicionar Novo Contato
              </h4>
              
              <div class="input-group">
                <label for="newContactName">Nome do Contato</label>
                <input type="text" id="newContactName" placeholder="Ex: João Silva">
              </div>
              
              <div class="input-group">
                <label for="newContactAddress">Endereço Polygon do Contato</label>
                <input type="text" id="newContactAddress" placeholder="0x..." style="font-family: 'Courier New', monospace;">
              </div>
              
              <button class="btn btn-primary" onclick="addNewContact()">
                <i class="fas fa-plus"></i> Adicionar Contato
              </button>
            </div>
            
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--card-border);">
              <p style="color: var(--text-secondary); font-size: 12px; line-height: 1.5;">
                <i class="fas fa-shield-alt"></i> Seus contatos são armazenados localmente e criptografados.
                Apenas você tem acesso à sua lista de contatos.
              </p>
            </div>
          </div>
        </div>

        <!-- Sub-aba: Chat Privado -->
        <div class="sub-tab-content hidden" id="chatTab">
          <div class="communication-main-container">
            <h3 class="address-registration-title">
              <i class="fas fa-comment-dots"></i> Chat Privado Criptografado
            </h3>
            
            <p class="address-instruction">
              Conversas privadas ponto-a-ponto criptografadas com tecnologia de ponta.
            </p>
            
            <!-- Seletor de contato para chat -->
            <div class="input-group">
              <label for="selectChatContact">Selecionar Contato para Conversar</label>
              <select id="selectChatContact" style="padding: 18px 15px;">
                <option value="">Selecione um contato</option>
              </select>
            </div>
            
            <!-- Área do chat -->
            <div class="chat-container">
              <div class="chat-messages" id="privateChatMessages">
                <div class="message message-received">
                  <div class="message-sender">Sistema</div>
                  <div>Selecione um contato para iniciar uma conversa privada.</div>
                  <div class="message-time">Agora</div>
                </div>
              </div>
              
              <div class="chat-input-area">
                <input type="text" class="chat-input" id="privateChatInput" placeholder="Digite sua mensagem..." 
                       onkeypress="handlePrivateChatKeyPress(event)" disabled>
                <button class="btn btn-primary btn-small" onclick="sendPrivateMessage()" disabled>
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
            
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--card-border);">
              <p style="color: var(--text-secondary); font-size: 12px; line-height: 1.5;">
                <i class="fas fa-lock"></i> Todas as mensagens são criptografadas ponto-a-ponto.
                Nem mesmo o servidor pode ler o conteúdo das suas conversas.
              </p>
            </div>
          </div>
        </div>

        <!-- Sub-aba: Vídeo Chamada -->
        <div class="sub-tab-content hidden" id="videoTab">
          <div class="communication-main-container">
            <h3 class="address-registration-title">
              <i class="fas fa-video"></i> Chamada de Vídeo Segura
            </h3>
            
            <p class="address-instruction">
              Chamadas de vídeo criptografadas com qualidade premium via WebRTC.
            </p>
            
            <!-- Seletor de contato para vídeo -->
            <div class="input-group">
              <label for="selectVideoContact">Selecionar Contato para Vídeo Chamada</label>
              <select id="selectVideoContact" style="padding: 18px 15px;">
                <option value="">Selecione um contato</option>
              </select>
            </div>
            
            <!-- Área do vídeo -->
            <div class="video-container" id="videoCallContainer">
              <div class="video-placeholder">
                <i class="fas fa-video"></i>
                <div>Chamada de vídeo não iniciada</div>
                <div style="font-size: 12px; margin-top: 10px;">Selecione um contato e clique em "Iniciar Vídeo"</div>
              </div>
            </div>
            
            <!-- Controles de vídeo -->
            <div class="video-controls">
              <button class="btn btn-primary btn-small" id="startVideoBtn" onclick="startVideoCall()">
                <i class="fas fa-video"></i> Iniciar Vídeo
              </button>
              <button class="btn btn-secondary btn-small" id="endVideoBtn" onclick="endVideoCall()" disabled>
                <i class="fas fa-phone-slash"></i> Encerrar
              </button>
              <button class="btn btn-secondary btn-small" id="toggleVideoBtn" onclick="toggleVideo()" disabled>
                <i class="fas fa-video-slash"></i> Desligar Vídeo
              </button>
              <button class="btn btn-secondary btn-small" id="toggleAudioBtn" onclick="toggleAudio()" disabled>
                <i class="fas fa-microphone-slash"></i> Silenciar
              </button>
            </div>
            
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--card-border);">
              <p style="color: var(--text-secondary); font-size: 12px; line-height: 1.5;">
                <i class="fas fa-shield-alt"></i> Sua chamada de vídeo é criptografada de ponta a ponta.
                A conexão é direta entre os participantes, sem servidores intermediários.
              </p>
            </div>
          </div>
        </div>

        <!-- Sub-aba: Grupos -->
        <div class="sub-tab-content hidden" id="groupTab">
          <div class="communication-main-container">
            <h3 class="address-registration-title">
              <i class="fas fa-users"></i> Grupos de Comunicação
            </h3>
            
            <p class="address-instruction">
              Crie e participe de grupos de chat para comunicação em comunidade.
            </p>
            
            <!-- Criar novo grupo -->
            <div class="add-contact-form" style="margin-bottom: 30px;">
              <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 16px;">
                <i class="fas fa-plus-circle"></i> Criar Novo Grupo
              </h4>
              
              <div class="input-group">
                <label for="groupName">Nome do Grupo</label>
                <input type="text" id="groupName" placeholder="Ex: Time de Desenvolvimento">
              </div>
              
              <button class="btn btn-primary" onclick="createNewGroup()">
                <i class="fas fa-plus"></i> Criar Grupo
              </button>
            </div>
            
            <!-- Lista de grupos disponíveis -->
            <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 16px;">
              <i class="fas fa-list"></i> Grupos Disponíveis
            </h4>
            
            <div class="dev-agenda-grid" id="availableGroups">
              <div class="agenda-entry">
                <div class="agenda-header">
                  <div class="agenda-title">Polygon Community</div>
                  <div class="agenda-status status-in-progress">Ativo</div>
                </div>
                <div class="agenda-description">Comunidade oficial de desenvolvedores Polygon.</div>
                <div class="agenda-footer">
                  <div>128 membros</div>
                  <button class="btn btn-secondary btn-small" onclick="joinGroup('Polygon Community')" style="padding: 4px 8px; font-size: 10px;">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Chat do grupo -->
            <div style="margin-top: 30px;">
              <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 16px;">
                <i class="fas fa-comments"></i> Chat do Grupo
              </h4>
              
              <div class="chat-container" style="height: 300px;">
                <div class="chat-messages" id="groupChatMessages">
                  <div class="message message-received">
                    <div class="message-sender">Sistema</div>
                    <div>Entre em um grupo para começar a conversar.</div>
                    <div class="message-time">Agora</div>
                  </div>
                </div>
                
                <div class="chat-input-area">
                  <input type="text" class="chat-input" id="groupChatInput" placeholder="Digite sua mensagem para o grupo..." 
                         onkeypress="handleGroupChatKeyPress(event)">
                  <button class="btn btn-primary btn-small" onclick="sendGroupMessage()">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sub-aba: Vídeo em Grupo -->
        <div class="sub-tab-content hidden" id="groupVideoTab">
          <div class="communication-main-container">
            <h3 class="address-registration-title">
              <i class="fas fa-video"></i> Reuniões de Vídeo em Grupo
            </h3>
            
            <p class="address-instruction">
              Reuniões de vídeo com múltiplos participantes via tecnologia WebRTC.
            </p>
            
            <!-- Layout reestruturado -->
            <div style="display: flex; gap: 30px; margin-bottom: 30px; flex-wrap: wrap;">
              <!-- Área de controles laterais -->
              <div style="flex: 0 0 250px; display: flex; flex-direction: column; gap: 15px;">
                <div style="background: var(--gradient-card); border: 1px solid var(--card-border); border-radius: 12px; padding: 20px;">
                  <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 16px;">
                    <i class="fas fa-plus-circle"></i> Criar Reunião
                  </h4>
                  <div class="input-group" style="margin-bottom: 15px;">
                    <label for="groupVideoName" style="font-size: 12px;">Nome da Reunião</label>
                    <input type="text" id="groupVideoName" placeholder="Ex: Reunião de Planejamento" style="padding: 12px 15px; font-size: 13px;">
                  </div>
                  <button class="btn btn-primary btn-small" onclick="createGroupVideo()" style="width: 100%;">
                    <i class="fas fa-video"></i> Criar Reunião
                  </button>
                </div>
                
                <div style="background: var(--gradient-card); border: 1px solid var(--card-border); border-radius: 12px; padding: 20px;">
                  <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 16px;">
                    <i class="fas fa-sign-in-alt"></i> Entrar na Reunião
                  </h4>
                  <div class="input-group" style="margin-bottom: 15px;">
                    <label for="groupVideoCode" style="font-size: 12px;">Código da Reunião</label>
                    <input type="text" id="groupVideoCode" placeholder="Digite o código" style="padding: 12px 15px; font-size: 13px;">
                  </div>
                  <button class="btn btn-primary btn-small" onclick="joinGroupVideo()" style="width: 100%;">
                    <i class="fas fa-users"></i> Entrar na Reunião
                  </button>
                </div>
                
                <!-- Controles de vídeo em grupo (inicialmente desabilitados) -->
                <div style="background: var(--gradient-card); border: 1px solid var(--card-border); border-radius: 12px; padding: 20px; display: none;" id="groupVideoControls">
                  <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 16px;">
                    <i class="fas fa-sliders-h"></i> Controles
                  </h4>
                  <div class="video-controls" style="flex-direction: column; gap: 10px;">
                    <button class="btn btn-secondary btn-small" id="toggleGroupVideoBtn" onclick="toggleGroupVideo()" disabled style="width: 100%;">
                      <i class="fas fa-video-slash"></i> Desligar Vídeo
                    </button>
                    <button class="btn btn-secondary btn-small" id="toggleGroupAudioBtn" onclick="toggleGroupAudio()" disabled style="width: 100%;">
                      <i class="fas fa-microphone-slash"></i> Silenciar
                    </button>
                    <button class="btn btn-secondary btn-small" id="leaveGroupVideoBtn" onclick="leaveGroupVideo()" disabled style="width: 100%;">
                      <i class="fas fa-sign-out-alt"></i> Sair da Reunião
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Área principal de vídeo -->
              <div style="flex: 1; min-width: 300px;">
                <!-- Área do vídeo em grupo -->
                <div class="video-container" id="groupVideoContainer" style="height: 400px; margin-bottom: 20px;">
                  <div class="video-placeholder">
                    <i class="fas fa-users" style="font-size: 48px; color: var(--text-secondary);"></i>
                    <div style="font-size: 18px; margin-top: 15px;">Nenhuma reunião ativa</div>
                    <div style="font-size: 13px; margin-top: 10px; color: var(--text-secondary); max-width: 400px; line-height: 1.5;">
                      Crie uma nova reunião ou entre em uma existente usando os controles ao lado
                    </div>
                  </div>
                </div>
                
                <!-- Lista de participantes -->
                <div>
                  <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 16px;">
                    <i class="fas fa-users"></i> Participantes
                  </h4>
                  
                  <div class="contacts-list-container" id="participantsList" style="max-height: 150px;">
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                      <i class="fas fa-user-friends"></i>
                      <div>Nenhum participante na reunião</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--card-border);">
              <p style="color: var(--text-secondary); font-size: 12px; line-height: 1.5;">
                <i class="fas fa-shield-alt"></i> Suas reuniões de vídeo são criptografadas de ponta a ponta.
                A conexão é direta entre os participantes, sem servidores intermediários.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Mnemônica (Criação) -->
  <div class="modal-overlay" id="mnemonicCreationModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-key"></i> Frase Mnemônica Gerada</h3>
        <button class="modal-close" id="closeMnemonicCreationModal">×</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-secondary); margin-bottom: 20px;">
          <strong>Anote esta frase em um local seguro.</strong> Ela é a única maneira de recuperar sua identidade Polygon.
        </p>
        <div class="mnemonic-timer-container">
          <div class="mnemonic-timer" id="mnemonicTimer">05:00</div>
          <div class="mnemonic-warning">
            <i class="fas fa-exclamation-triangle"></i> Tempo para anotar antes que a frase desapareça
          </div>
        </div>
        <div class="mnemonic-words" id="mnemonicWordsContainer">
          <!-- Palavras serão inseridas aqui -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelWalletCreation">Cancelar Criação</button>
        <button class="btn btn-primary" id="confirmMnemonicSaved">Já anotei, continuar</button>
      </div>
    </div>
  </div>

  <!-- Modal para Mnemônica (Restauração) -->
  <div class="modal-overlay" id="mnemonicModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-redo"></i> Restaurar Identidade Polygon</h3>
        <button class="modal-close" id="closeMnemonicModal">×</button>
      </div>
      <div class="modal-body">
        <div class="input-group">
          <label for="mnemonicPhrase">Frase Mnemônica (12 ou 24 palavras)</label>
          <textarea id="mnemonicPhrase" rows="3" placeholder="insira sua frase mnemônica aqui..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelRestore">Cancelar</button>
        <button class="btn btn-primary" id="confirmRestore">Restaurar Identidade</button>
      </div>
    </div>
  </div>

  <!-- Modal para criação de wallet em outras chains -->
  <div class="modal-overlay" id="mnemonicCreationModalOther">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-key"></i> Frase Mnemônica Gerada - <span id="currentChainName"></span></h3>
        <button class="modal-close" id="closeMnemonicCreationModalOther">×</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-secondary); margin-bottom: 20px;">
          <strong>Anote esta frase em um local seguro.</strong> Ela é a única maneira de recuperar sua wallet na <span id="chainNameText"></span>.
          Você tem <strong>5 minutos</strong> para anotar. Após esse tempo, ela nunca mais será exibida.
        </p>
        <div class="mnemonic-timer-container">
          <div class="mnemonic-timer" id="mnemonicTimerOther">05:00</div>
          <div class="mnemonic-warning">
            <i class="fas fa-exclamation-triangle"></i> Tempo para anotar antes que a frase desapareça
          </div>
        </div>
        <div class="mnemonic-words" id="mnemonicWordsContainerOther">
          <!-- Palavras serão inseridas aqui -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelWalletCreationOther">Cancelar Criação</button>
        <button class="btn btn-primary" id="confirmMnemonicSavedOther">Já anotei, continuar</button>
      </div>
    </div>
  </div>

  <!-- Modal para restauração em outras chains -->
  <div class="modal-overlay" id="mnemonicModalOther">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-redo"></i> Restaurar Wallet - <span id="restoreChainName"></span></h3>
        <button class="modal-close" id="closeMnemonicModalOther">×</button>
      </div>
      <div class="modal-body">
        <div class="input-group">
          <label for="mnemonicPhraseOther">Frase Mnemônica (12 ou 24 palavras)</label>
          <textarea id="mnemonicPhraseOther" rows="3" placeholder="insira sua frase mnemônica aqui..."></textarea>
        </div>
        <div class="input-group" style="margin-top: 20px;">
          <label for="privateKeyOther">Ou Chave Privada</label>
          <input type="password" id="privateKeyOther" placeholder="0x..." style="font-family: 'Courier New', monospace;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelRestoreOther">Cancelar</button>
        <button class="btn btn-primary" id="confirmRestoreOther">Restaurar Wallet</button>
      </div>
    </div>
  </div>

  <!-- Modal para Autorização Identity -->
  <div class="modal-overlay" id="identityAuthModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-shield-alt"></i> Autorização Identity Dynamic - Polygon</h3>
        <button class="modal-close" onclick="closeIdentityAuthModal()">×</button>
      </div>
      <div class="modal-body">
        <div style="background: var(--gradient-card); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <h4 style="color: var(--primary-color); margin-bottom: 10px; font-size: 16px;">
            Identity Dynamic – Autorização de Infraestrutura
          </h4>
          <p style="color: var(--text-secondary); font-size: 13px; line-height: 1.5;">
            Esta wallet está prestes a se conectar à infraestrutura Identity Dynamic (Polygon).
            Para garantir acesso exclusivo e seguro, sua wallet assinará uma mensagem temporária que prova:
          </p>
          <ul style="color: var(--text-secondary); font-size: 12px; margin-top: 10px; padding-left: 20px;">
            <li>posse da chave</li>
            <li>sessão ativa na Identity</li>
            <li>autorização para uso do túnel RPC</li>
          </ul>
          <p style="color: var(--text-secondary); font-size: 12px; margin-top: 10px; font-style: italic;">
            Nenhuma transação será executada. Nenhuma taxa será cobrada.
            Esta assinatura é usada apenas para autenticação de infraestrutura.
          </p>
        </div>

        <div style="background: rgba(212, 175, 55, 0.05); padding: 15px; border-radius: 10px; border: 1px solid rgba(212, 175, 55, 0.2); margin-bottom: 20px;">
          <h5 style="color: var(--primary-color); margin-bottom: 10px; font-size: 14px;">
            <i class="fas fa-code"></i> Formato da Mensagem (EXATO)
          </h5>
          <div style="font-family: 'Courier New', monospace; font-size: 11px; background: var(--card-bg); padding: 10px; border-radius: 6px; color: var(--text-primary); white-space: pre-wrap;">
IDENTITY_DYNAMIC_ACCESS
wallet:<span id="identityWalletAddressPreview">0x0ba3...9DaC7f</span>
session:<span id="identitySessionPreview">session_id_123</span>
issued_at:<span id="identityTimestampPreview">1704067200</span>
chain:polygon
scope:rpc
          </div>
          <p style="color: var(--text-secondary); font-size: 11px; margin-top: 8px;">
            ⚠️ As quebras de linha importam. Polygon fixo (por enquanto).
          </p>
        </div>

        <div id="identityAuthResult" style="display: none; margin-top: 20px; padding: 15px; border-radius: 10px; background: rgba(0, 200, 83, 0.1); border: 1px solid var(--success-color);">
          <div style="color: var(--success-color); font-size: 13px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-check-circle"></i> <span id="identityAuthResultText">Autorização bem-sucedida!</span>
          </div>
          <div id="identitySignaturePreview" style="font-family: 'Courier New', monospace; font-size: 10px; color: var(--text-secondary); margin-top: 10px; word-break: break-all;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeIdentityAuthModal()">Fechar</button>
        <button class="btn btn-primary" id="identityAuthorizeBtn" onclick="performIdentityDynamicAuth()">
          <i class="fas fa-key"></i> Autorizar Identity Dynamic
        </button>
      </div>
    </div>
  </div>

  <!-- Notificação -->
  <div class="notification" id="notification">
    <div id="notificationMessage">✅ Identidade Polygon conectada!</div>
  </div>

  <script>
    const { ethers } = window;
    let currentWallet = null;
    let currentTheme = 'luxury';
    let privateKeyVisible = false;
    let mnemonicVisible = false;
    let mnemonicPhrase = null;
    let mnemonicCreationTimer = null;
    let mnemonicTimerSeconds = 300;
    let isAddressRegistered = false;
    
    // INFRA IDENTITY - RPC CONFIGURAÇÃO
    let currentRpcProvider = 'https://polygon-rpc.com';
    let polygonProvider = null;
    let networkStatus = {
      connected: false,
      latency: 0,
      lastBlock: 0,
      gasPrice: '30'
    };

    // Configurações da Polygon
    const polygonConfig = {
      name: 'Polygon',
      chainId: 137,
      symbol: 'MATIC',
      explorer: 'https://polygonscan.com',
      decimals: 18,
      rpcUrls: [
        'https://polygon-rpc.com',
        'https://identitydynamic.avizaecosystem.workers.dev',
        'https://rpc-mainnet.maticvigil.com',
        'https://polygon-mainnet.infura.io/v3/',
        'https://matic-mainnet.chainstacklabs.com'
      ]
    };

    // LISTA DE 20 BLOCKCHAINS
    const blockchains = [
      { id: 'polygon', name: 'Polygon', symbol: 'MATIC', chainId: 137 },
      { id: 'ethereum', name: 'Ethereum', symbol: 'ETH', chainId: 1 },
      { id: 'bsc', name: 'BSC', symbol: 'BNB', chainId: 56 },
      { id: 'avalanche', name: 'Avalanche', symbol: 'AVAX', chainId: 43114 },
      { id: 'fantom', name: 'Fantom', symbol: 'FTM', chainId: 250 },
      { id: 'arbitrum', name: 'Arbitrum', symbol: 'ETH', chainId: 42161 },
      { id: 'optimism', name: 'Optimism', symbol: 'ETH', chainId: 10 },
      { id: 'base', name: 'Base', symbol: 'ETH', chainId: 8453 },
      { id: 'cronos', name: 'Cronos', symbol: 'CRO', chainId: 25 },
      { id: 'harmony', name: 'Harmony', symbol: 'ONE', chainId: 1666600000 },
      { id: 'kava', name: 'Kava', symbol: 'KAVA', chainId: 2222 },
      { id: 'celo', name: 'Celo', symbol: 'CELO', chainId: 42220 },
      { id: 'moonbeam', name: 'Moonbeam', symbol: 'GLMR', chainId: 1284 },
      { id: 'moonriver', name: 'Moonriver', symbol: 'MOVR', chainId: 1285 },
      { id: 'gnosis', name: 'Gnosis', symbol: 'xDAI', chainId: 100 },
      { id: 'fuse', name: 'Fuse', symbol: 'FUSE', chainId: 122 },
      { id: 'metis', name: 'Metis', symbol: 'METIS', chainId: 1088 },
      { id: 'polygonzkevm', name: 'Polygon zkEVM', symbol: 'ETH', chainId: 1101 },
      { id: 'linea', name: 'Linea', symbol: 'ETH', chainId: 59144 },
      { id: 'scroll', name: 'Scroll', symbol: 'ETH', chainId: 534352 }
    ];

    // Wallets para outras chains
    const otherChainsWallets = {};
    let currentSelectedChain = 'polygon';
    let mnemonicCreationTimerOther = null;
    let mnemonicTimerSecondsOther = 300;
    let currentChainForCreation = '';

    // VARIÁVEIS PARA COMUNICAÇÃO
    let authorizedChatAddress = null;
    let contacts = [];
    let currentChatContact = null;
    let videoStream = null;
    let peerConnection = null;
    let groupVideoStream = null;

    // VARIÁVEIS PARA IDENTITY DYNAMIC
    let identityDynamicAuthorized = false;
    let identityDynamicSessionId = null;
    let identityDynamicSignature = null;

    // SALDOS REAIS DAS BLOCKCHAINS (simulados inicialmente)
    const realChainBalances = {
      polygon: '0.0000',
      ethereum: '0.0000',
      bsc: '0.0000',
      avalanche: '0.0000',
      fantom: '0.0000',
      arbitrum: '0.0000',
      optimism: '0.0000',
      base: '0.0000',
      cronos: '0.0000',
      harmony: '0.0000',
      kava: '0.0000',
      celo: '0.0000',
      moonbeam: '0.0000',
      moonriver: '0.0000',
      gnosis: '0.0000',
      fuse: '0.0000',
      metis: '0.0000',
      polygonzkevm: '0.0000',
      linea: '0.0000',
      scroll: '0.0000'
    };

    // FUNÇÕES PRINCIPAIS EXISTENTES (intactas)
    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      const messageElement = document.getElementById('notificationMessage');
      
      messageElement.textContent = message;
      
      const colors = {
        info: 'var(--primary-color)',
        success: 'var(--success-color)',
        warning: 'var(--warning-color)',
        error: 'var(--error-color)'
      };
      
      notification.style.borderColor = colors[type] || colors.info;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 4000);
    }

    function toggleTheme() {
      currentTheme = currentTheme === 'light' ? 'luxury' : 'light';
      document.body.className = `theme-${currentTheme}`;
      localStorage.setItem('premiumWalletTheme', currentTheme);
      updateThemeButton();
    }

    function updateThemeButton() {
      const themeToggle = document.getElementById('themeToggle');
      if (currentTheme === 'light') {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i> Modo Escuro';
      } else {
        themeToggle.innerHTML = '<i class="fas fa-sun"></i> Modo Claro';
      }
    }

    // ======================================================
    // IDENTITY DYNAMIC RPC - FUNÇÕES ESPECÍFICAS
    // ======================================================

    function showIdentityAuthorizationInfo() {
      if (!currentWallet) {
        showNotification('Conecte uma wallet Polygon primeiro', 'error');
        return;
      }

      const modal = document.getElementById('identityAuthModal');
      const walletPreview = document.getElementById('identityWalletAddressPreview');
      const sessionPreview = document.getElementById('identitySessionPreview');
      const timestampPreview = document.getElementById('identityTimestampPreview');

      const timestamp = Math.floor(Date.now() / 1000);
      const sessionId = ethers.id(currentWallet.address + timestamp).substring(0, 20);

      walletPreview.textContent = currentWallet.address.substring(0, 6) + '...' + currentWallet.address.substring(38);
      sessionPreview.textContent = sessionId;
      timestampPreview.textContent = timestamp;

      document.getElementById('identityAuthResult').style.display = 'none';
      document.getElementById('identityAuthorizeBtn').disabled = false;
      document.getElementById('identityAuthorizeBtn').innerHTML = '<i class="fas fa-key"></i> Autorizar Identity Dynamic';

      modal.classList.add('active');
    }

    function closeIdentityAuthModal() {
      document.getElementById('identityAuthModal').classList.remove('active');
    }

    async function performIdentityDynamicAuth() {
      if (!currentWallet) {
        showNotification('Wallet não conectada', 'error');
        return;
      }

      try {
        const btn = document.getElementById('identityAuthorizeBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Autorizando...';

        // 1. Dados base
        const walletAddress = currentWallet.address.toLowerCase();
        const timestamp = Math.floor(Date.now() / 1000).toString();

        // 2. Session ID (simples e válido)
        identityDynamicSessionId = ethers.id(walletAddress + timestamp).substring(0, 32);

        // 3. Mensagem Identity (EXATA conforme especificado)
        const message = [
          "IDENTITY_DYNAMIC_ACCESS",
          `wallet:${walletAddress}`,
          `session:${identityDynamicSessionId}`,
          `issued_at:${timestamp}`,
          "chain:polygon",
          "scope:rpc"
        ].join("\n");

        // 4. Assinatura
        identityDynamicSignature = await currentWallet.signMessage(message);
        
        // 5. Após autorizar, mudar o RPC para Identity Dynamic
        currentRpcProvider = 'https://identitydynamic.avizaecosystem.workers.dev';
        localStorage.setItem('exclusiveWalletRpc', currentRpcProvider);

        // Atualizar o select na aba Infra Identity
        document.getElementById('rpcProviderSelect').value = currentRpcProvider;

        // Re-inicializar o provider
        initializeRpcProvider();
        
        // 6. Mostrar resultado
        const authResult = document.getElementById('identityAuthResult');
        const resultText = document.getElementById('identityAuthResultText');
        const signaturePreview = document.getElementById('identitySignaturePreview');

        authResult.style.display = 'block';
        resultText.textContent = 'Autorização Identity Dynamic bem-sucedida!';
        signaturePreview.textContent = `Assinatura: ${identityDynamicSignature.substring(0, 40)}...`;

        identityDynamicAuthorized = true;
        localStorage.setItem('identityDynamicAuth', 'true');
        localStorage.setItem('identityDynamicSession', identityDynamicSessionId);
        localStorage.setItem('identityDynamicSignature', identityDynamicSignature);

        showNotification('✅ Autorização Identity Dynamic realizada com sucesso!', 'success');

        // Habilitar o botão novamente
        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-key"></i> Autorização Concluída';
        }, 2000);

      } catch (error) {
        console.error('Erro na autorização Identity Dynamic:', error);
        showNotification('Erro na autorização Identity: ' + error.message, 'error');
        
        const btn = document.getElementById('identityAuthorizeBtn');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-key"></i> Tentar Novamente';
      }
    }

    async function testIdentityDynamicConnection() {
      if (!currentWallet) {
        showNotification('Conecte uma wallet Polygon primeiro', 'error');
        return;
      }

      if (!identityDynamicAuthorized && !localStorage.getItem('identityDynamicAuth')) {
        showNotification('Autorize primeiro o Identity Dynamic', 'error');
        showIdentityAuthorizationInfo();
        return;
      }

      showNotification('Testando conexão Identity Dynamic...', 'info');

      try {
        // Usar dados salvos ou gerar novos
        const walletAddress = currentWallet.address.toLowerCase();
        const timestamp = Math.floor(Date.now() / 1000).toString();
        const sessionId = identityDynamicSessionId || localStorage.getItem('identityDynamicSession') || ethers.id(walletAddress + timestamp).substring(0, 32);
        const signature = identityDynamicSignature || localStorage.getItem('identityDynamicSignature');

        if (!signature) {
          showNotification('Reautorize o Identity Dynamic', 'error');
          showIdentityAuthorizationInfo();
          return;
        }

        // Chamada RPC via Identity Dynamic
        const response = await fetch(
          "https://identitydynamic.avizaecosystem.workers.dev",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-identity-wallet": walletAddress,
              "x-identity-timestamp": timestamp,
              "x-identity-session": sessionId,
              "x-identity-signature": signature
            },
            body: JSON.stringify({
              jsonrpc: "2.0",
              method: "eth_blockNumber",
              params: [],
              id: 1
            })
          }
        );

        const data = await response.json();

        if (data.result) {
          const blockNumber = parseInt(data.result, 16);
          networkStatus.lastBlock = blockNumber;
          networkStatus.connected = true;
          updateRpcStatus();
          
          showNotification(`✅ Identity Dynamic conectado! Bloco: ${blockNumber.toLocaleString()}`, 'success');
        } else if (data.error) {
          showNotification(`Identity Dynamic: ${data.error.message}`, 'error');
        }

      } catch (error) {
        console.error('Erro ao testar Identity Dynamic:', error);
        showNotification('Falha na conexão Identity Dynamic', 'error');
      }
    }

    async function callIdentityDynamicRPC(method, params = []) {
      if (!currentWallet || !identityDynamicAuthorized) {
        throw new Error('Wallet não autorizada para Identity Dynamic');
      }

      const walletAddress = currentWallet.address.toLowerCase();
      const timestamp = Math.floor(Date.now() / 1000).toString();
      const sessionId = identityDynamicSessionId;

      const response = await fetch(
        "https://identitydynamic.avizaecosystem.workers.dev",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-identity-wallet": walletAddress,
            "x-identity-timestamp": timestamp,
            "x-identity-session": sessionId,
            "x-identity-signature": identityDynamicSignature
          },
          body: JSON.stringify({
            jsonrpc: "2.0",
            method: method,
            params: params,
            id: 1
          })
        }
      );

      return await response.json();
    }

    // ======================================================
    // FUNÇÕES EXISTENTES MODIFICADAS PARA SUPORTAR IDENTITY DYNAMIC
    // ======================================================

    function initializeRpcProvider() {
      try {
        const savedRpc = localStorage.getItem('exclusiveWalletRpc') || currentRpcProvider;
        currentRpcProvider = savedRpc;
        
        // Verificar se é Identity Dynamic
        if (currentRpcProvider.includes('identitydynamic')) {
          if (!identityDynamicAuthorized && !localStorage.getItem('identityDynamicAuth')) {
            showNotification('Identity Dynamic requer autorização. Usando RPC padrão.', 'warning');
            currentRpcProvider = 'https://polygon-rpc.com';
            localStorage.setItem('exclusiveWalletRpc', currentRpcProvider);
          }
        }
        
        polygonProvider = new ethers.JsonRpcProvider(currentRpcProvider, {
          chainId: polygonConfig.chainId,
          name: polygonConfig.name
        });
        
        document.getElementById('currentRpcUrl').textContent = currentRpcProvider;
        document.getElementById('rpcProviderSelect').value = currentRpcProvider;
        
        updateRpcStatus();
        showNotification('Provider RPC Polygon inicializado', 'success');
        
        return true;
      } catch (error) {
        console.error('Erro ao inicializar RPC Provider:', error);
        showNotification('Erro ao conectar ao RPC Polygon', 'error');
        return false;
      }
    }

    async function testRpcConnection() {
      // Se for Identity Dynamic, usar método específico
      if (currentRpcProvider.includes('identitydynamic')) {
        await testIdentityDynamicConnection();
        return;
      }
      
      if (!polygonProvider) {
        showNotification('Provider RPC não inicializado', 'error');
        return;
      }
      
      showNotification('Testando conexão com RPC Polygon...', 'info');
      
      try {
        const startTime = Date.now();
        const blockNumber = await polygonProvider.getBlockNumber();
        const endTime = Date.now();
        
        networkStatus.latency = endTime - startTime;
        networkStatus.lastBlock = blockNumber;
        networkStatus.connected = true;
        
        const feeData = await polygonProvider.getFeeData();
        networkStatus.gasPrice = Math.round(Number(ethers.formatUnits(feeData.gasPrice || '30000000000', 'gwei')));
        
        updateRpcStatus();
        
        showNotification(`✅ Conexão RPC estabelecida! Latência: ${networkStatus.latency}ms`, 'success');
        
      } catch (error) {
        console.error('Erro ao testar conexão RPC:', error);
        networkStatus.connected = false;
        updateRpcStatus();
        showNotification('❌ Falha na conexão RPC', 'error');
      }
    }

    function updateRpcProvider() {
      const newRpc = document.getElementById('rpcProviderSelect').value;
      
      if (!newRpc) {
        showNotification('Selecione um provedor RPC', 'error');
        return;
      }
      
      // Verificar se é Identity Dynamic e se está autorizado
      if (newRpc.includes('identitydynamic') && !identityDynamicAuthorized && !localStorage.getItem('identityDynamicAuth')) {
        showNotification('Autorize o Identity Dynamic antes de usar', 'warning');
        showIdentityAuthorizationInfo();
        return;
      }
      
      currentRpcProvider = newRpc;
      localStorage.setItem('exclusiveWalletRpc', newRpc);
      
      showNotification('Atualizando provedor RPC...', 'info');
      
      if (initializeRpcProvider()) {
        testRpcConnection();
      }
    }

    // ======================================================
    // NOVAS FUNÇÕES PARA SALDOS REAIS DAS BLOCKCHAINS
    // ======================================================

    async function refreshRealChainBalance(chainId) {
      const chain = blockchains.find(c => c.id === chainId);
      if (!chain) {
        console.error('Blockchain não encontrada:', chainId);
        return '0.0000';
      }
      
      // Se for Polygon e temos wallet conectada, buscar saldo real
      if (chainId === 'polygon' && currentWallet && polygonProvider && networkStatus.connected) {
        try {
          const balance = await polygonProvider.getBalance(currentWallet.address);
          const balanceFormatted = ethers.formatEther(balance);
          realChainBalances[chainId] = parseFloat(balanceFormatted).toFixed(4);
          return realChainBalances[chainId];
        } catch (error) {
          console.error('Erro ao buscar saldo Polygon:', error);
          return '0.0000';
        }
      }
      
      // Para outras chains, simular saldos (em produção, integraria com RPCs reais)
      if (otherChainsWallets[chainId]) {
        // Se a wallet existe, gerar um saldo aleatório para demonstração
        if (!realChainBalances[chainId] || realChainBalances[chainId] === '0.0000') {
          const randomBalance = (Math.random() * 10).toFixed(4);
          realChainBalances[chainId] = randomBalance;
        }
        return realChainBalances[chainId];
      }
      
      // Se não tem wallet criada, saldo zero
      return '0.0000';
    }

    async function updateCurrentChainBalance() {
      if (!currentSelectedChain) return;
      
      const balance = await refreshRealChainBalance(currentSelectedChain);
      const balanceElement = document.getElementById('currentChainBalance');
      if (balanceElement) {
        balanceElement.textContent = balance;
        
        // Atualizar também o elemento específico da chain
        const specificElement = document.getElementById(`currentChainBalance${currentSelectedChain.charAt(0).toUpperCase() + currentSelectedChain.slice(1)}`);
        if (specificElement) {
          specificElement.textContent = balance;
        }
        
        // Atualizar valor em USD (simulado)
        const chain = blockchains.find(c => c.id === currentSelectedChain);
        let usdValue = '≈ $0.00 USD';
        
        if (chain) {
          const priceMultipliers = {
            polygon: 0.8,
            ethereum: 3500,
            bsc: 300,
            avalanche: 35,
            arbitrum: 3500,
            optimism: 3500,
            base: 3500,
            harmony: 0.02,
            // outros...
          };
          
          const multiplier = priceMultipliers[chain.id] || 1;
          const usdAmount = parseFloat(balance) * multiplier;
          usdValue = `≈ $${usdAmount.toFixed(2)} USD`;
        }
        
        const valueElement = document.getElementById('currentChainValue');
        if (valueElement) {
          valueElement.textContent = usdValue;
        }
      }
    }

    // ======================================================
    // FUNÇÕES MODIFICADAS PARA INTEGRAÇÃO COM NOVOS REQUISITOS
    // ======================================================

    async function refreshBalance() {
      if (!currentWallet) {
        showNotification('Conecte uma wallet primeiro', 'error');
        return;
      }
      
      // Se for Identity Dynamic, usar método específico
      if (currentRpcProvider.includes('identitydynamic')) {
        if (!identityDynamicAuthorized) {
          showNotification('Autorize o Identity Dynamic primeiro', 'error');
          showIdentityAuthorizationInfo();
          return;
        }
        
        showNotification('Consultando saldo via Identity Dynamic...', 'info');
        
        try {
          const result = await callIdentityDynamicRPC('eth_getBalance', [currentWallet.address, 'latest']);
          
          if (result.result) {
            const balance = BigInt(result.result);
            const balanceInMatic = ethers.formatEther(balance.toString());
            
            realChainBalances.polygon = parseFloat(balanceInMatic).toFixed(4);
            updateCurrentChainBalance();
            
            const maticPrice = 0.8;
            const usdValue = parseFloat(balanceInMatic) * maticPrice;
            document.getElementById('currentChainValue').textContent = `≈ $${usdValue.toFixed(2)} USD`;
            
            showNotification('Saldo Polygon atualizado via Identity Dynamic!', 'success');
          } else {
            showNotification('Erro ao consultar saldo via Identity', 'error');
          }
        } catch (error) {
          console.error('Erro Identity Dynamic:', error);
          showNotification('Falha Identity Dynamic, usando RPC padrão', 'warning');
          // Tentar com RPC padrão como fallback
          currentRpcProvider = 'https://polygon-rpc.com';
          localStorage.setItem('exclusiveWalletRpc', currentRpcProvider);
          initializeRpcProvider();
          refreshBalance();
        }
        return;
      }
      
      if (!polygonProvider || !networkStatus.connected) {
        showNotification('Conecte-se ao RPC primeiro', 'error');
        return;
      }
      
      showNotification('Consultando saldo na Polygon...', 'info');
      
      try {
        const balance = await polygonProvider.getBalance(currentWallet.address);
        const balanceInMatic = ethers.formatEther(balance);
        
        realChainBalances.polygon = parseFloat(balanceInMatic).toFixed(4);
        updateCurrentChainBalance();
        
        const maticPrice = 0.8;
        const usdValue = parseFloat(balanceInMatic) * maticPrice;
        document.getElementById('currentChainValue').textContent = `≈ $${usdValue.toFixed(2)} USD`;
        
        showNotification('Saldo Polygon atualizado com sucesso!', 'success');
        
      } catch (error) {
        console.error('Erro ao consultar saldo:', error);
        showNotification('Erro ao consultar saldo na Polygon', 'error');
      }
    }

    // ======================================================
    // FUNÇÕES PARA QR CODE E CARTÃO DE LUXO
    // ======================================================

    function downloadQRCodeAsCard() {
      if (!currentWallet) {
        showNotification('Nenhuma wallet conectada', 'error');
        return;
      }

      const { jsPDF } = window.jspdf;
      if (!jsPDF) {
        showNotification('Biblioteca PDF não carregada', 'error');
        return;
      }

      showNotification('Gerando Cartão de Luxo do QR Code...', 'info');

      try {
        const qrCanvas = document.querySelector('#qrCodeCanvas canvas');
        if (!qrCanvas) {
          throw new Error('QR Code não gerado');
        }

        const qrDataURL = qrCanvas.toDataURL('image/png');
        const address = currentWallet.address;
        const shortAddress = `${address.substring(0, 10)}...${address.substring(address.length - 8)}`;
        const currentDate = new Date();
        const formattedDate = currentDate.toLocaleDateString('pt-BR', {
          day: '2-digit',
          month: 'long',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        // Criar PDF no formato cartão (A4 horizontal dividido em 2)
        const doc = new jsPDF({
          orientation: 'landscape',
          unit: 'mm',
          format: 'a4'
        });

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const cardWidth = pageWidth / 2 - 20;
        const cardHeight = pageHeight - 40;

        // ===== PRIMEIRO CARTÃO =====
        // Fundo de luxo
        doc.setFillColor(26, 26, 26);
        doc.rect(15, 20, cardWidth, cardHeight, 'F');
        
        // Borda dourada
        doc.setDrawColor(212, 175, 55);
        doc.setLineWidth(1.5);
        doc.rect(15, 20, cardWidth, cardHeight);

        // Logo e título
        doc.setTextColor(212, 175, 55);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(20);
        doc.text('Identity Premium', cardWidth / 2 + 15, 35, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setTextColor(244, 228, 184);
        doc.text('Cartão de Endereço Polygon', cardWidth / 2 + 15, 42, { align: 'center' });

        // QR Code
        const qrSize = 80;
        const qrX = (cardWidth - qrSize) / 2 + 15;
        doc.addImage(qrDataURL, 'PNG', qrX, 50, qrSize, qrSize);

        // Endereço
        doc.setFontSize(9);
        doc.setTextColor(240, 240, 240);
        doc.text('Endereço Polygon:', cardWidth / 2 + 15, 140, { align: 'center' });
        
        doc.setFont('courier', 'normal');
        doc.setFontSize(8);
        doc.setTextColor(212, 175, 55);
        const addressLines = doc.splitTextToSize(address, cardWidth - 30);
        doc.text(addressLines, cardWidth / 2 + 15, 148, { align: 'center' });

        // Informações
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.setTextColor(176, 176, 176);
        doc.text(`Gerado em: ${formattedDate}`, cardWidth / 2 + 15, 165, { align: 'center' });
        doc.text('Licença Vitalícia • Sistema Polygon Premium', cardWidth / 2 + 15, 170, { align: 'center' });

        // ===== SEGUNDO CARTÃO =====
        const secondCardX = pageWidth / 2 + 5;
        
        // Fundo de luxo
        doc.setFillColor(10, 10, 10);
        doc.rect(secondCardX, 20, cardWidth, cardHeight, 'F');
        
        // Borda dourada
        doc.setDrawColor(212, 175, 55);
        doc.rect(secondCardX, 20, cardWidth, cardHeight);

        // Título do segundo cartão
        doc.setTextColor(212, 175, 55);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(18);
        doc.text('INFORMAÇÕES DE SEGURANÇA', pageWidth / 4 * 3, 35, { align: 'center' });

        // Instruções
        doc.setFontSize(8);
        doc.setTextColor(244, 228, 184);
        doc.text('Este QR Code é pessoal e intransferível:', secondCardX + 10, 50);
        
        doc.setFontSize(7);
        doc.setTextColor(176, 176, 176);
        
        const instructions = [
          '• Use para receber MATIC e tokens na Polygon',
          '• Compatível com todas as wallets Polygon',
          '• Este QR Code não expira',
          '• Mantenha este cartão em local seguro',
          '• Não compartilhe publicamente',
          '• Verifique sempre o endereço antes de enviar',
          '• Dados do endereço de origem como um Cartão de Luxo',
          '• Para usar e receber valores em Polygon Network',
          '• Formato PDF premium exclusivo'
        ];

        let yPos = 60;
        instructions.forEach(instruction => {
          doc.text(instruction, secondCardX + 15, yPos);
          yPos += 5;
        });

        // QR Code menor para referência
        doc.addImage(qrDataURL, 'PNG', secondCardX + cardWidth / 2 - 25, yPos + 10, 50, 50);

        // Texto de licença em minúsculas
        doc.setFontSize(6);
        doc.setTextColor(100, 100, 100);
        doc.text('este qrcode foi gerado através da licença vitalícia da Identity Premium', 
                pageWidth / 4 * 3, pageHeight - 15, { align: 'center' });

        // Salvar PDF
        const fileName = `cartao-qrcode-polygon-${shortAddress}-${currentDate.getTime()}.pdf`;
        doc.save(fileName);

        showNotification(`✅ Cartão de Luxo salvo como ${fileName}`, 'success');

      } catch (error) {
        console.error('Erro ao gerar cartão:', error);
        showNotification('Erro ao gerar Cartão de Luxo: ' + error.message, 'error');
      }
    }

    // ======================================================
    // FUNÇÕES EXISTENTES (mantidas da versão anterior)
    // ======================================================

    function showReceiveModal() {
      document.getElementById('qrCodeContainer').style.display = 'block';
      document.getElementById('sendFormContainer').style.display = 'none';
      
      if (currentWallet) {
        document.getElementById('qrAddressDisplay').textContent = currentWallet.address;
        
        const qrCodeElement = document.getElementById('qrCodeCanvas');
        qrCodeElement.innerHTML = '';
        
        // Configurações diferentes para tema claro/escuro
        const qrColors = currentTheme === 'light' ? {
          dark: '#1A1A1A',
          light: '#FFFFFF'
        } : {
          dark: '#1A1A1A',
          light: '#FFFFFF'
        };
        
        QRCode.toCanvas(qrCodeElement, currentWallet.address, {
          width: 180,
          height: 180,
          color: qrColors
        }, function(error) {
          if (error) {
            console.error('Erro ao gerar QR Code:', error);
            qrCodeElement.innerHTML = '<div style="color: var(--text-secondary); padding: 20px;">Erro ao gerar QR Code</div>';
          }
        });
      }
    }

    async function connectPrivateKey() {
      const pk = document.getElementById('privateKey').value.trim();
      if(!pk){ 
        showNotification('Insira sua chave privada Polygon', 'error');
        return;
      }
      
      let privateKey = pk.replace(/\s/g, '');
      if (!privateKey.startsWith('0x')) {
        privateKey = '0x' + privateKey;
      }
      
      try {
        currentWallet = new ethers.Wallet(privateKey);
        localStorage.setItem('exclusiveWalletPK', privateKey);
        
        // Verificar autorização Identity Dynamic salva
        if (localStorage.getItem('identityDynamicAuth') === 'true') {
          identityDynamicAuthorized = true;
          identityDynamicSessionId = localStorage.getItem('identityDynamicSession');
          identityDynamicSignature = localStorage.getItem('identityDynamicSignature');
        }
        
        initializeRpcProvider();
        
        showNotification(`✅ Identidade Polygon conectada! Endereço: ${currentWallet.address.substring(0, 10)}...`, 'success');
        showWalletDashboard();
        
      } catch (error) {
        console.error('Erro ao conectar identidade Polygon:', error);
        showNotification('Erro ao conectar identidade Polygon. Verifique sua chave privada.', 'error');
      }
    }

    async function createNewWallet() {
      try {
        showNotification('Criando identidade Polygon premium...', 'info');
        
        const wallet = ethers.Wallet.createRandom();
        currentWallet = wallet;
        mnemonicPhrase = wallet.mnemonic.phrase;
        
        localStorage.setItem('exclusiveWalletPK', currentWallet.privateKey);
        
        const password = document.getElementById('newWalletPassword').value.trim();
        if (password) {
          localStorage.setItem('exw_psw', password);
          showNotification('Senha local salva (apenas neste dispositivo).', 'info');
        }
        
        showMnemonicCreationModal(mnemonicPhrase);
        
      } catch (error) {
        console.error('Erro ao criar identidade Polygon:', error);
        showNotification('Erro ao criar identidade Polygon premium: ' + error.message, 'error');
      }
    }

    function showMnemonicCreationModal(mnemonic) {
      const modal = document.getElementById('mnemonicCreationModal');
      const wordsContainer = document.getElementById('mnemonicWordsContainer');
      const timerElement = document.getElementById('mnemonicTimer');
      
      const words = mnemonic.split(' ');
      wordsContainer.innerHTML = '';
      
      words.forEach((word, index) => {
        const wordElement = document.createElement('div');
        wordElement.className = 'mnemonic-word';
        wordElement.setAttribute('data-index', index + 1);
        wordElement.textContent = word;
        wordsContainer.appendChild(wordElement);
      });
      
      mnemonicTimerSeconds = 300;
      updateMnemonicTimer();
      mnemonicCreationTimer = setInterval(updateMnemonicTimer, 1000);
      
      modal.classList.add('active');
    }

    function updateMnemonicTimer() {
      const timerElement = document.getElementById('mnemonicTimer');
      if (!timerElement) return;
      
      mnemonicTimerSeconds--;
      
      if (mnemonicTimerSeconds <= 0) {
        clearInterval(mnemonicCreationTimer);
        timerElement.textContent = '00:00';
        showNotification('Tempo esgotado! A criação da identidade foi cancelada.', 'error');
        closeMnemonicCreationModal();
        return;
      }
      
      const minutes = Math.floor(mnemonicTimerSeconds / 60);
      const seconds = mnemonicTimerSeconds % 60;
      timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function closeMnemonicCreationModal() {
      const modal = document.getElementById('mnemonicCreationModal');
      modal.classList.remove('active');
      clearInterval(mnemonicCreationTimer);
      
      currentWallet = null;
      mnemonicPhrase = null;
      localStorage.removeItem('exclusiveWalletPK');
      localStorage.removeItem('exw_psw');
    }

    function confirmMnemonicSaved() {
      clearInterval(mnemonicCreationTimer);
      
      initializeRpcProvider();
      
      showNotification(`✅ Identidade Polygon criada! Endereço: ${currentWallet.address.substring(0, 10)}...`, 'success');
      showNotification('⚠️ SALVE SUA CHAVE PRIVADA E FRASE MNEMÔNICA!', 'warning');
      closeMnemonicCreationModal();
      showWalletDashboard();
    }

    function updateSensitiveDataDisplay() {
      if (!currentWallet) return;
      
      document.getElementById('privateKeyDisplay').textContent = privateKeyVisible ? 
        currentWallet.privateKey : '••••••••••••••••••••••••••••••••••••••••••••••';
      
      document.getElementById('mnemonicDisplay').textContent = mnemonicVisible && mnemonicPhrase ? 
        mnemonicPhrase : '••••••••••••••••••••••••••••••••••••••••••••••';
      
      document.getElementById('togglePrivateKey').innerHTML = `<i class="fas fa-${privateKeyVisible ? 'eye-slash' : 'eye'}"></i> ${privateKeyVisible ? 'Ocultar' : 'Mostrar'} Chave`;
      document.getElementById('toggleMnemonic').innerHTML = `<i class="fas fa-${mnemonicVisible ? 'eye-slash' : 'eye'}"></i> ${mnemonicVisible ? 'Ocultar' : 'Mostrar'} Frase`;
    }

    function updateOverview() {
      if (!currentWallet) return;
      
      const address = currentWallet.address;
      const formattedAddress = `${address.substring(0, 6)}...${address.substring(address.length - 6)}`;
      
      document.getElementById('walletAddressDisplay').textContent = formattedAddress;
      document.getElementById('walletStatus').textContent = 'Ativo';
      document.getElementById('featureCount').textContent = '6';
      document.getElementById('securityLevel').textContent = 'Máxima';
      
      updateAddressRegistration();
    }

    function updateAddressRegistration() {
      if (!currentWallet) return;
      
      const addressDisplay = document.getElementById('publicAddressDisplay');
      const checkbox = document.getElementById('confirmAddressCheckbox');
      const registerBtn = document.getElementById('registerAddressBtn');
      const statusText = document.getElementById('statusText');
      const statusIndicator = document.getElementById('statusIndicator');
      
      addressDisplay.textContent = currentWallet.address;
      
      if (isAddressRegistered) {
        checkbox.checked = true;
        checkbox.disabled = true;
        registerBtn.disabled = false;
        registerBtn.innerHTML = '<i class="fas fa-check"></i> Identidade Registrada';
        registerBtn.classList.remove('btn-secondary');
        registerBtn.classList.add('btn-success');
        statusText.textContent = 'Identidade Polygon verificada e registrada';
        statusText.style.color = 'var(--success-color)';
        statusIndicator.className = 'status-indicator verified';
      } else {
        checkbox.checked = false;
        checkbox.disabled = false;
        registerBtn.disabled = true;
        registerBtn.innerHTML = '<i class="fas fa-check"></i> Registrar Identidade';
        registerBtn.classList.remove('btn-success');
        registerBtn.classList.add('btn-secondary');
        statusText.textContent = 'Identidade não registrada';
        statusText.style.color = 'var(--text-secondary)';
        statusIndicator.className = 'status-indicator';
        statusIndicator.style.background = 'var(--text-secondary)';
      }
      
      checkbox.onchange = function() {
        registerBtn.disabled = !this.checked;
      };
      
      registerBtn.onclick = function() {
        if (!checkbox.checked) return;
        
        isAddressRegistered = true;
        localStorage.setItem('exclusiveWalletAddressRegistered', 'true');
        
        updateAddressRegistration();
        showNotification('✅ Identidade Polygon registrada com sucesso!', 'success');
      };
    }

    async function sendTransaction() {
      const toAddress = document.getElementById('sendToAddress').value.trim();
      const amount = document.getElementById('sendAmount').value.trim();
      
      if (!currentWallet || !polygonProvider || !networkStatus.connected) {
        showNotification('Conecte-se ao RPC primeiro', 'error');
        return;
      }
      
      if (!toAddress) {
        showNotification('Informe o endereço de destino Polygon', 'error');
        return;
      }
      
      if (!amount || parseFloat(amount) <= 0) {
        showNotification('Informe uma quantia válida em MATIC', 'error');
        return;
      }
      
      try {
        showNotification('Preparando transação na Polygon...', 'info');
        
        const connectedWallet = currentWallet.connect(polygonProvider);
        
        const tx = {
          to: toAddress,
          value: ethers.parseEther(amount),
          gasLimit: 21000
        };
        
        const estimatedGas = await connectedWallet.estimateGas(tx);
        tx.gasLimit = estimatedGas;
        
        const feeData = await polygonProvider.getFeeData();
        tx.maxFeePerGas = feeData.maxFeePerGas;
        tx.maxPriorityFeePerGas = feeData.maxPriorityFeePerGas;
        
        showNotification('Enviando transação...', 'info');
        
        const transaction = await connectedWallet.sendTransaction(tx);
        
        showNotification(`✅ Transação enviada! Hash: ${transaction.hash.substring(0, 10)}...`, 'success');
        
        document.getElementById('sendToAddress').value = '';
        document.getElementById('sendAmount').value = '';
        
        setTimeout(() => {
          refreshBalance();
        }, 3000);
        
      } catch (error) {
        console.error('Erro ao enviar transação:', error);
        showNotification('Erro ao enviar transação: ' + error.message, 'error');
      }
    }

    async function estimateGas() {
      const toAddress = document.getElementById('sendToAddress').value.trim();
      const amount = document.getElementById('sendAmount').value.trim();
      
      if (!toAddress || !amount) {
        showNotification('Preencha endereço e valor primeiro', 'error');
        return;
      }
      
      if (!polygonProvider || !networkStatus.connected) {
        showNotification('Conecte-se ao RPC primeiro', 'error');
        return;
      }
      
      try {
        showNotification('Estimando custo do gás...', 'info');
        
        const tx = {
          to: toAddress,
          value: ethers.parseEther(amount)
        };
        
        const connectedWallet = currentWallet.connect(polygonProvider);
        const estimatedGas = await connectedWallet.estimateGas(tx);
        
        const feeData = await polygonProvider.getFeeData();
        const gasPrice = feeData.maxFeePerGas || feeData.gasPrice;
        
        const gasCost = estimatedGas * gasPrice;
        const gasCostInMatic = ethers.formatEther(gasCost);
        
        const maticPrice = 0.8;
        const usdCost = parseFloat(gasCostInMatic) * maticPrice;
        
        document.getElementById('estimatedGasCost').textContent = `$${usdCost.toFixed(2)} (${parseFloat(gasCostInMatic).toFixed(6)} MATIC)`;
        
        showNotification('Estimativa de gás calculada', 'success');
        
      } catch (error) {
        console.error('Erro ao estimar gás:', error);
        showNotification('Erro ao estimar gás: ' + error.message, 'error');
      }
    }

    function copyAddress() {
      if (!currentWallet) return;
      
      navigator.clipboard.writeText(currentWallet.address)
        .then(() => showNotification('Endereço Polygon copiado!', 'success'))
        .catch(() => showNotification('Erro ao copiar endereço', 'error'));
    }

    function togglePrivateKeyVisibility() {
      if (!currentWallet) return;
      
      privateKeyVisible = !privateKeyVisible;
      updateSensitiveDataDisplay();
      showNotification(privateKeyVisible ? 'Chave privada Polygon visível' : 'Chave privada Polygon ocultada', 'info');
    }

    function toggleMnemonicVisibility() {
      if (!mnemonicPhrase) {
        showNotification('Nenhuma frase mnemônica disponível para esta identidade', 'error');
        return;
      }
      
      mnemonicVisible = !mnemonicVisible;
      updateSensitiveDataDisplay();
      showNotification(mnemonicVisible ? 'Frase mnemônica visível' : 'Frase mnemônica ocultada', 'info');
    }

    function copyPrivateKey() {
      if (!currentWallet) return;
      
      navigator.clipboard.writeText(currentWallet.privateKey)
        .then(() => showNotification('Chave privada Polygon copiada!', 'success'))
        .catch(() => showNotification('Erro ao copiar chave privada', 'error'));
    }

    function copyMnemonic() {
      if (!mnemonicPhrase) {
        showNotification('Nenhuma frase mnemônica disponível', 'error');
        return;
      }
      
      navigator.clipboard.writeText(mnemonicPhrase)
        .then(() => showNotification('Frase mnemônica copiada!', 'success'))
        .catch(() => showNotification('Erro ao copiar frase mnemônica', 'error'));
    }

    function showPrivateKey() {
      if (!currentWallet) return;
      
      if (confirm('⚠️ ATENÇÃO: A chave privada dá acesso total aos seus fundos na Polygon. Tem certeza que deseja visualizar?')) {
        alert(`SUA CHAVE PRIVADA POLYGON:\n\n${currentWallet.privateKey}\n\n⚠️ NUNCA COMPARTILHE ESTA INFORMAÇÃO!`);
      }
    }

    function exportWallet() {
      if (!currentWallet) return;
      
      const walletData = {
        address: currentWallet.address,
        privateKey: currentWallet.privateKey,
        mnemonic: mnemonicPhrase,
        chain: 'Polygon',
        rpc: currentRpcProvider,
        exportDate: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(walletData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `polygon-identity-${currentWallet.address.slice(0, 10)}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showNotification('Identidade Polygon exportada com sucesso!', 'success');
    }

    function disconnectWallet() {
      if (confirm('Encerrar sessão premium da Polygon?')) {
        currentWallet = null;
        mnemonicPhrase = null;
        isAddressRegistered = false;
        networkStatus.connected = false;
        identityDynamicAuthorized = false;
        identityDynamicSessionId = null;
        identityDynamicSignature = null;
        
        localStorage.removeItem('exclusiveWalletPK');
        localStorage.removeItem('exclusiveWalletAddressRegistered');
        localStorage.removeItem('identityDynamicAuth');
        localStorage.removeItem('identityDynamicSession');
        localStorage.removeItem('identityDynamicSignature');
        
        document.getElementById('wallet-dashboard').classList.add('fade-out');
        
        setTimeout(() => {
          document.getElementById('wallet-dashboard').classList.add('hidden');
          document.getElementById('login-screen').classList.remove('hidden');
          document.getElementById('login-screen').classList.remove('fade-out');
          document.getElementById('login-screen').classList.add('fade-in');
          
          document.getElementById('privateKey').value = '';
          document.getElementById('newWalletPassword').value = '';
          
          showNotification('Sessão Polygon premium encerrada.', 'info');
        }, 800);
      }
    }

    function showWalletDashboard() {
      document.getElementById('login-screen').classList.add('fade-out');
      
      setTimeout(() => {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('wallet-dashboard').classList.remove('hidden');
        document.getElementById('wallet-dashboard').classList.add('fade-in');
        
        updateSensitiveDataDisplay();
        updateOverview();
        refreshBalance();
        testRpcConnection();
        initializeBlockchainButtons();
        
        // Inicializar comunicação
        loadContacts();
        updateAuthorizationStatus();
        
      }, 800);
    }

    function openMnemonicModal() {
      document.getElementById('mnemonicModal').classList.add('active');
    }

    function closeMnemonicModal() {
      document.getElementById('mnemonicModal').classList.remove('active');
      document.getElementById('mnemonicPhrase').value = '';
    }

    function restoreWalletFromMnemonic() {
      const mnemonicPhraseInput = document.getElementById('mnemonicPhrase').value.trim();

      if (!mnemonicPhraseInput) {
        showNotification('Por favor, insira a frase mnemônica.', 'error');
        return;
      }

      try {
        if (!ethers.Mnemonic.isValidMnemonic(mnemonicPhraseInput)) {
          showNotification('Frase mnemônica inválida. Verifique as palavras.', 'error');
          return;
        }

        const wallet = ethers.Wallet.fromPhrase(mnemonicPhraseInput);
        currentWallet = wallet;
        mnemonicPhrase = mnemonicPhraseInput;

        localStorage.setItem('exclusiveWalletPK', currentWallet.privateKey);
        
        initializeRpcProvider();

        closeMnemonicModal();
        showNotification(`✅ Identidade Polygon restaurada! Endereço: ${currentWallet.address.substring(0, 10)}...`, 'success');
        showWalletDashboard();

      } catch (error) {
        console.error('Erro ao restaurar identidade Polygon:', error);
        showNotification('Erro ao restaurar identidade Polygon: ' + error.message, 'error');
      }
    }

    function switchTab(tabId) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      const targetTab = document.getElementById(tabId);
      if (!targetTab) return;
      
      document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
      targetTab.classList.add('active');
      
      if (tabId === 'infraIdentityTab') {
        testRpcConnection();
      }
      
      if (tabId === 'walletTab') {
        showCorrectWalletForChain();
        updateCurrentChainBalance();
      }
      
      if (tabId === 'communicationTab') {
        loadContacts();
        updateAuthorizationStatus();
      }
      
      // Inicializar agenda quando a aba for ativada
      if (tabId === 'agendaTab') {
        agendaSystem.init();
      }
    }

    function showSecurityInfoModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-shield-alt"></i> Informações Técnicas</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
          </div>
          <div class="modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
              <strong>PROTOCOLO DE SEGURANÇA PREMIUM POLYGON</strong>
            </p>
            <ul style="color: var(--text-secondary); padding-left: 20px; margin-bottom: 25px;">
              <li>Criptografia ponta a ponta (AES-256 + ECC)</li>
              <li>Chaves armazenadas apenas localmente</li>
              <li>Sem backdoor ou acesso de terceiros</li>
              <li>Zero rastreamento de dados</li>
              <li>Comunicação via canais criptografados</li>
              <li>RPC Tunnel proprietário</li>
            </ul>
            <p style="color: var(--warning-color); font-size: 13px;">
              <i class="fas fa-exclamation-triangle"></i> Status: ATIVO E OPERACIONAL
            </p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Fechar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function showRecoveryBox() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-key"></i> Protocolo de Recuperação Polygon</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
          </div>
          <div class="modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
              Sua segurança na Polygon depende exclusivamente de você:
            </p>
            <ul style="color: var(--text-secondary); padding-left: 20px; margin-bottom: 25px;">
              <li>Salve a <strong>chave privada Polygon</strong> e <strong>frase mnemônica</strong> em local seguro</li>
              <li>Não compartilhe com ninguem</li>
              <li>Faça backup físico (papel/metal)</li>
              <li>O desenvolvedor NÃO tem acesso aos seus dados</li>
            </ul>
            <p style="color: var(--warning-color); font-size: 13px;">
              <i class="fas fa-exclamation-triangle"></i> Perda da chave = perda permanente dos fundos na Polygon
            </p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Entendido</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function copyQRAddress() {
      if (!currentWallet) return;
      
      navigator.clipboard.writeText(currentWallet.address)
        .then(() => showNotification('Endereço Polygon copiado!', 'success'))
        .catch(() => showNotification('Erro ao copiar endereço', 'error'));
    }

    function cancelSend() {
      document.getElementById('sendFormContainer').style.display = 'none';
      showNotification('Envio na Polygon cancelado', 'info');
    }

    function loadMoreTransactions() {
      showNotification('Carregando mais transações Polygon...', 'info');
      setTimeout(() => {
        showNotification('Transações Polygon carregadas', 'success');
      }, 1000);
    }

    // ======================================================
    // FUNÇÕES PARA A NOVA ABA "BLOCKCHAINS"
    // ======================================================

    // Inicializar botões de blockchains
    function initializeBlockchainButtons() {
      const container = document.getElementById('blockchainButtonsContainer');
      if (!container) return;
      
      container.innerHTML = '';
      
      blockchains.forEach(chain => {
        const button = document.createElement('button');
        button.className = 'blockchain-button';
        button.setAttribute('data-chain', chain.id);
        button.textContent = chain.name;
        
        if (chain.id === currentSelectedChain) {
          button.classList.add('active');
        }
        
        button.addEventListener('click', () => {
          selectBlockchain(chain.id);
        });
        
        container.appendChild(button);
      });
    }

    // Selecionar uma blockchain
    async function selectBlockchain(chainId) {
      document.querySelectorAll('.blockchain-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-chain') === chainId) {
          btn.classList.add('active');
        }
      });
      
      currentSelectedChain = chainId;
      
      // Ir direto para a aba wallet
      switchTab('walletTab');
      
      // Atualizar o saldo da chain selecionada
      await updateCurrentChainBalance();
      
      if (chainId === 'polygon') {
        showNotification(`Dashboard Polygon carregado`, 'success');
      } else {
        const chainName = blockchains.find(c => c.id === chainId).name;
        showNotification(`Dashboard da ${chainName} carregado`, 'success');
      }
    }

    // Mostrar a wallet correta para a chain selecionada
    function showCorrectWalletForChain() {
      document.querySelectorAll('.wallet-tab-other').forEach(el => {
        el.classList.remove('active');
        el.style.display = 'none';
      });
      
      document.getElementById('walletTab').style.display = 'none';
      
      if (currentSelectedChain === 'polygon') {
        document.getElementById('walletTab').style.display = 'block';
        return;
      }
      
      const otherWalletId = `walletTab${currentSelectedChain.charAt(0).toUpperCase() + currentSelectedChain.slice(1)}`;
      let otherWallet = document.getElementById(otherWalletId);
      
      if (!otherWallet) {
        // Criar wallet para a chain se não existir
        const chain = blockchains.find(c => c.id === currentSelectedChain);
        if (chain) {
          // Em vez de criar automaticamente, apenas mostrar os botões de criação
          createChainWalletInterface(currentSelectedChain);
          otherWallet = document.getElementById(otherWalletId);
        }
      }
      
      if (otherWallet) {
        otherWallet.classList.add('active');
        otherWallet.style.display = 'block';
      }
    }

    // Criar interface de wallet para uma chain específica
    function createChainWalletInterface(chainId) {
      const chain = blockchains.find(c => c.id === chainId);
      if (!chain) return;
      
      const walletTab = document.getElementById('walletTab');
      if (!walletTab) return;
      
      const newWallet = walletTab.cloneNode(true);
      newWallet.id = `walletTab${chainId.charAt(0).toUpperCase() + chainId.slice(1)}`;
      newWallet.className = 'tab-content wallet-tab-other';
      
      const chainName = chain.name;
      const chainSymbol = chain.symbol;
      
      // Atualizar textos
      const titleElement = newWallet.querySelector('.wallet-header h2');
      if (titleElement) {
        titleElement.innerHTML = `<i class="fas fa-wallet"></i> Wallet ${chainName} Premium`;
      }
      
      const subtitleElement = newWallet.querySelector('.wallet-header p');
      if (subtitleElement) {
        subtitleElement.textContent = `Gerencie seus fundos na ${chainName} com elegância minimalista e funcionalidades completas`;
      }
      
      // Atualizar elementos de saldo
      const balanceLabel = newWallet.querySelector('.balance-main-container .balance-label:nth-child(1)');
      if (balanceLabel) {
        balanceLabel.textContent = `Saldo na ${chainName} Network`;
      }
      
      const balanceDisplay = newWallet.querySelector('.balance-main-container .balance-display');
      if (balanceDisplay) {
        balanceDisplay.id = `currentChainBalance${chainId.charAt(0).toUpperCase() + chainId.slice(1)}`;
        balanceDisplay.textContent = realChainBalances[chainId] || '0.0000';
      }
      
      const balanceSymbol = newWallet.querySelector('.balance-main-container .balance-label:nth-child(3)');
      if (balanceSymbol) {
        balanceSymbol.textContent = chainSymbol;
      }
      
      // Atualizar IDs dos elementos
      updateWalletElementIds(newWallet, chainId);
      
      // Adicionar botões específicos da chain
      addChainSpecificButtons(newWallet, chainName, chainId);
      
      // Adicionar ao DOM
      document.getElementById('wallet-dashboard').appendChild(newWallet);
    }

    // Atualizar IDs dos elementos na wallet clonada
    function updateWalletElementIds(walletElement, chainId) {
      const suffix = chainId.charAt(0).toUpperCase() + chainId.slice(1);
      
      // Atualizar todos os elementos com ID
      const allElements = walletElement.querySelectorAll('[id]');
      allElements.forEach(el => {
        if (el.id && !el.id.endsWith(suffix)) {
          el.id = `${el.id}${suffix}`;
        }
      });
      
      // Atualizar labels
      const labels = walletElement.querySelectorAll('label[for]');
      labels.forEach(label => {
        const oldFor = label.getAttribute('for');
        if (oldFor && !oldFor.endsWith(suffix)) {
          label.setAttribute('for', `${oldFor}${suffix}`);
        }
      });
    }

    // Adicionar botões específicos da chain
    function addChainSpecificButtons(walletElement, chainName, chainId) {
      const walletOperationsGrid = walletElement.querySelector('.wallet-operations-grid');
      if (walletOperationsGrid) {
        // Criar container para botões específicos
        const chainButtonsContainer = document.createElement('div');
        chainButtonsContainer.className = 'chain-specific-buttons';
        chainButtonsContainer.innerHTML = `
          <button class="btn btn-primary btn-small" onclick="createWalletForChain('${chainName}')">
            <i class="fas fa-gem"></i> Criar Wallet ${chainName}
          </button>
          <button class="btn btn-secondary btn-small" onclick="restoreWalletForChain('${chainName}')">
            <i class="fas fa-redo"></i> Recuperar Wallet
          </button>
        `;
        
        walletOperationsGrid.parentNode.insertBefore(chainButtonsContainer, walletOperationsGrid.nextSibling);
      }
      
      // Configurar botões de ação
      const actionButtons = walletElement.querySelectorAll('.action-btn');
      actionButtons.forEach((btn, index) => {
        btn.onclick = null;
        if (index === 0) {
          btn.onclick = () => showReceiveModalOther(chainName);
        } else if (index === 1) {
          btn.onclick = () => showSendModalOther(chainName);
        } else if (index === 2) {
          btn.onclick = () => refreshBalanceOther(chainName);
        }
      });
    }

    // ======================================================
    // FUNÇÕES PARA WALLETS DE OUTRAS CHAINS
    // ======================================================

    // Criar wallet para outra chain
    function createWalletForChain(chainName) {
      currentChainForCreation = chainName.toLowerCase();
      
      try {
        showNotification(`Criando wallet ${chainName} premium...`, 'info');
        
        const wallet = ethers.Wallet.createRandom();
        otherChainsWallets[currentChainForCreation] = {
          wallet: wallet,
          mnemonic: wallet.mnemonic.phrase
        };
        
        localStorage.setItem(`exclusiveWallet_${currentChainForCreation}`, wallet.privateKey);
        localStorage.setItem(`exclusiveWalletMnemonic_${currentChainForCreation}`, wallet.mnemonic.phrase);
        
        // Gerar saldo aleatório para demonstração
        const randomBalance = (Math.random() * 10).toFixed(4);
        realChainBalances[currentChainForCreation] = randomBalance;
        
        showMnemonicCreationModalOther(wallet.mnemonic.phrase, chainName);
        
      } catch (error) {
        console.error(`Erro ao criar wallet ${chainName}:`, error);
        showNotification(`Erro ao criar wallet ${chainName}: ` + error.message, 'error');
      }
    }

    function showMnemonicCreationModalOther(mnemonic, chainName) {
      const modal = document.getElementById('mnemonicCreationModalOther');
      const wordsContainer = document.getElementById('mnemonicWordsContainerOther');
      const timerElement = document.getElementById('mnemonicTimerOther');
      const chainNameElement = document.getElementById('currentChainName');
      const chainNameText = document.getElementById('chainNameText');
      
      chainNameElement.textContent = chainName;
      chainNameText.textContent = chainName;
      
      const words = mnemonic.split(' ');
      wordsContainer.innerHTML = '';
      
      words.forEach((word, index) => {
        const wordElement = document.createElement('div');
        wordElement.className = 'mnemonic-word';
        wordElement.setAttribute('data-index', index + 1);
        wordElement.textContent = word;
        wordsContainer.appendChild(wordElement);
      });
      
      mnemonicTimerSecondsOther = 300;
      updateMnemonicTimerOther();
      mnemonicCreationTimerOther = setInterval(updateMnemonicTimerOther, 1000);
      
      modal.classList.add('active');
    }

    function updateMnemonicTimerOther() {
      const timerElement = document.getElementById('mnemonicTimerOther');
      if (!timerElement) return;
      
      mnemonicTimerSecondsOther--;
      
      if (mnemonicTimerSecondsOther <= 0) {
        clearInterval(mnemonicCreationTimerOther);
        timerElement.textContent = '00:00';
        showNotification('Tempo esgotado! A criação da wallet foi cancelada.', 'error');
        closeMnemonicCreationModalOther();
        return;
      }
      
      const minutes = Math.floor(mnemonicTimerSecondsOther / 60);
      const seconds = mnemonicTimerSecondsOther % 60;
      timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function closeMnemonicCreationModalOther() {
      const modal = document.getElementById('mnemonicCreationModalOther');
      modal.classList.remove('active');
      clearInterval(mnemonicCreationTimerOther);
      
      delete otherChainsWallets[currentChainForCreation];
      localStorage.removeItem(`exclusiveWallet_${currentChainForCreation}`);
      localStorage.removeItem(`exclusiveWalletMnemonic_${currentChainForCreation}`);
      
      currentChainForCreation = '';
    }

    function confirmMnemonicSavedOther() {
      clearInterval(mnemonicCreationTimerOther);
      
      const chainName = document.getElementById('currentChainName').textContent;
      const wallet = otherChainsWallets[currentChainForCreation];
      
      if (wallet) {
        // Atualizar saldo
        updateCurrentChainBalance();
        
        showNotification(`✅ Wallet ${chainName} criada! Endereço: ${wallet.wallet.address.substring(0, 10)}...`, 'success');
        showNotification(`⚠️ SALVE SUA CHAVE PRIVADA E FRASE MNEMÔNICA DA ${chainName.toUpperCase()}!`, 'warning');
      }
      
      closeMnemonicCreationModalOther();
    }

    // Restaurar wallet para outra chain
    function restoreWalletForChain(chainName) {
      currentChainForCreation = chainName.toLowerCase();
      
      const modal = document.getElementById('mnemonicModalOther');
      const chainNameElement = document.getElementById('restoreChainName');
      
      chainNameElement.textContent = chainName;
      modal.classList.add('active');
      
      document.getElementById('mnemonicPhraseOther').value = '';
      document.getElementById('privateKeyOther').value = '';
    }

    function closeMnemonicModalOther() {
      const modal = document.getElementById('mnemonicModalOther');
      modal.classList.remove('active');
      currentChainForCreation = '';
    }

    function confirmRestoreOther() {
      const mnemonicPhraseInput = document.getElementById('mnemonicPhraseOther').value.trim();
      const privateKeyInput = document.getElementById('privateKeyOther').value.trim();
      
      if (!mnemonicPhraseInput && !privateKeyInput) {
        showNotification('Por favor, insira a frase mnemônica ou chave privada.', 'error');
        return;
      }
      
      try {
        let wallet;
        
        if (mnemonicPhraseInput) {
          if (!ethers.Mnemonic.isValidMnemonic(mnemonicPhraseInput)) {
            showNotification('Frase mnemônica inválida. Verifique as palavras.', 'error');
            return;
          }
          wallet = ethers.Wallet.fromPhrase(mnemonicPhraseInput);
        } else {
          let privateKey = privateKeyInput.replace(/\s/g, '');
          if (!privateKey.startsWith('0x')) {
            privateKey = '0x' + privateKey;
          }
          wallet = new ethers.Wallet(privateKey);
        }
        
        otherChainsWallets[currentChainForCreation] = {
          wallet: wallet,
          mnemonic: mnemonicPhraseInput || ''
        };
        
        localStorage.setItem(`exclusiveWallet_${currentChainForCreation}`, wallet.privateKey);
        if (mnemonicPhraseInput) {
          localStorage.setItem(`exclusiveWalletMnemonic_${currentChainForCreation}`, mnemonicPhraseInput);
        }
        
        // Gerar saldo aleatório para demonstração
        const randomBalance = (Math.random() * 10).toFixed(4);
        realChainBalances[currentChainForCreation] = randomBalance;
        
        closeMnemonicModalOther();
        showNotification(`✅ Wallet ${currentChainForCreation.charAt(0).toUpperCase() + currentChainForCreation.slice(1)} restaurada! Endereço: ${wallet.address.substring(0, 10)}...`, 'success');
        
        // Atualizar saldo exibido
        updateCurrentChainBalance();
        
      } catch (error) {
        console.error('Erro ao restaurar wallet:', error);
        showNotification('Erro ao restaurar wallet: ' + error.message, 'error');
      }
    }

    // Funções para outras chains
    function showReceiveModalOther(chainName) {
      const chainId = chainName.toLowerCase();
      const wallet = otherChainsWallets[chainId];
      
      if (!wallet) {
        showNotification(`Crie ou restaure uma wallet ${chainName} primeiro`, 'error');
        return;
      }
      
      showNotification(`QR Code para recebimento na ${chainName} (simulado)`, 'info');
    }

    function showSendModalOther(chainName) {
      showNotification(`Envio na ${chainName} (simulado)`, 'info');
    }

    async function refreshBalanceOther(chainName) {
      const chainId = chainName.toLowerCase();
      showNotification(`Consultando saldo na ${chainName}...`, 'info');
      
      // Atualizar saldo real
      await updateCurrentChainBalance();
      
      showNotification(`Saldo ${chainName} atualizado!`, 'success');
    }

    function copyQRAddressOther(chainName) {
      const chainId = chainName.toLowerCase();
      const wallet = otherChainsWallets[chainId];
      
      if (!wallet) {
        showNotification(`Nenhuma wallet ${chainName} encontrada`, 'error');
        return;
      }
      
      navigator.clipboard.writeText(wallet.wallet.address)
        .then(() => showNotification(`Endereço ${chainName} copiado!`, 'success'))
        .catch(() => showNotification('Erro ao copiar endereço', 'error'));
    }

    function cancelSendOther(chainName) {
      showNotification(`Envio na ${chainName} cancelado`, 'info');
    }

    function estimateGasOther(chainName) {
      showNotification(`Estimando gás na ${chainName}... (simulado)`, 'info');
      setTimeout(() => {
        showNotification(`Estimativa de gás ${chainName} calculada`, 'success');
      }, 1000);
    }

    function sendTransactionOther(chainName) {
      showNotification(`Enviando transação na ${chainName}... (simulado)`, 'info');
      setTimeout(() => {
        showNotification(`✅ Transação ${chainName} enviada com sucesso!`, 'success');
      }, 2000);
    }

    function loadMoreTransactionsOther(chainName) {
      showNotification(`Carregando mais transações ${chainName}...`, 'info');
      setTimeout(() => {
        showNotification(`Transações ${chainName} carregadas`, 'success');
      }, 1000);
    }

    // ======================================================
    // FUNÇÕES PARA A ABA DE COMUNICAÇÃO
    // ======================================================

    // Autorizar acesso ao chat
    function authorizeChatAccess() {
      const address = document.getElementById('authWalletAddress').value.trim();
      
      if (!address) {
        showNotification('Insira um endereço Polygon válido', 'error');
        return;
      }
      
      if (!address.startsWith('0x') || address.length !== 42) {
        showNotification('Endereço Polygon inválido', 'error');
        return;
      }
      
      authorizedChatAddress = address;
      localStorage.setItem('exclusiveWalletChatAuth', address);
      
      updateAuthorizationStatus();
      showNotification('✅ Acesso ao chat autorizado com sucesso!', 'success');
    }

    // Atualizar status de autorização
    function updateAuthorizationStatus() {
      const savedAuth = localStorage.getItem('exclusiveWalletChatAuth');
      const indicator = document.getElementById('authStatusIndicator');
      const statusText = document.getElementById('authStatusText');
      
      if (savedAuth) {
        authorizedChatAddress = savedAuth;
        document.getElementById('authWalletAddress').value = savedAuth;
        
        indicator.className = 'status-indicator verified';
        indicator.style.background = 'var(--success-color)';
        statusText.textContent = 'Autorizado';
        statusText.style.color = 'var(--success-color)';
      } else {
        indicator.className = 'status-indicator';
        indicator.style.background = 'var(--text-secondary)';
        statusText.textContent = 'Não autorizado';
        statusText.style.color = 'var(--text-secondary)';
      }
    }

    // Carregar contatos
    function loadContacts() {
      const savedContacts = localStorage.getItem('exclusiveWalletContacts');
      contacts = savedContacts ? JSON.parse(savedContacts) : [];
      
      updateContactsList();
      updateContactSelects();
    }

    // Atualizar lista de contatos
    function updateContactsList() {
      const container = document.getElementById('contactsList');
      if (!container) return;
      
      container.innerHTML = '';
      
      if (contacts.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            <i class="fas fa-users" style="font-size: 24px; margin-bottom: 10px;"></i>
            <div>Nenhum contato adicionado</div>
          </div>
        `;
        return;
      }
      
      contacts.forEach((contact, index) => {
        const contactElement = document.createElement('div');
        contactElement.className = 'contact-item';
        contactElement.innerHTML = `
          <div class="contact-info">
            <i class="fas fa-user-circle" style="color: var(--primary-color); font-size: 20px;"></i>
            <div>
              <div style="font-weight: 500;">${contact.name || 'Sem nome'}</div>
              <div style="font-size: 11px; color: var(--text-secondary); font-family: 'Courier New', monospace;">
                ${contact.address.substring(0, 10)}...${contact.address.substring(contact.address.length - 8)}
              </div>
            </div>
          </div>
          <div class="contact-actions">
            <button class="btn btn-secondary btn-small" onclick="startChatWithContact('${contact.address}')">
              <i class="fas fa-comment"></i>
            </button>
            <button class="btn btn-secondary btn-small" onclick="removeContact(${index})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        container.appendChild(contactElement);
      });
    }

    // Atualizar selects de contatos
    function updateContactSelects() {
      const chatSelect = document.getElementById('selectChatContact');
      const videoSelect = document.getElementById('selectVideoContact');
      
      if (chatSelect) {
        chatSelect.innerHTML = '<option value="">Selecione um contato Polygon para conversar</option>';
        contacts.forEach(contact => {
          const option = document.createElement('option');
          option.value = contact.address;
          option.textContent = `${contact.name || 'Sem nome'} (${contact.address.substring(0, 8)}...)`;
          chatSelect.appendChild(option);
        });
      }
      
      if (videoSelect) {
        videoSelect.innerHTML = '<option value="">Selecione um contato Polygon para vídeo</option>';
        contacts.forEach(contact => {
          const option = document.createElement('option');
          option.value = contact.address;
          option.textContent = `${contact.name || 'Sem nome'} (${contact.address.substring(0, 8)}...)`;
          videoSelect.appendChild(option);
        });
      }
    }

    // Adicionar novo contato
    function addNewContact() {
      const address = document.getElementById('newContactAddress').value.trim();
      const name = document.getElementById('newContactName').value.trim();
      
      if (!address) {
        showNotification('Insira um endereço Polygon válido', 'error');
        return;
      }
      
      if (!address.startsWith('0x') || address.length !== 42) {
        showNotification('Endereço Polygon inválido', 'error');
        return;
      }
      
      // Verificar se já existe
      if (contacts.some(c => c.address.toLowerCase() === address.toLowerCase())) {
        showNotification('Este contato já foi adicionado', 'error');
        return;
      }
      
      contacts.push({
        address: address,
        name: name || `Contato ${contacts.length + 1}`,
        addedDate: new Date().toISOString()
      });
      
      localStorage.setItem('exclusiveWalletContacts', JSON.stringify(contacts));
      
      document.getElementById('newContactAddress').value = '';
      document.getElementById('newContactName').value = '';
      
      updateContactsList();
      updateContactSelects();
      
      showNotification('✅ Contato Polygon adicionado com sucesso!', 'success');
    }

    // Remover contato
    function removeContact(index) {
      if (confirm('Remover este contato da sua lista?')) {
        contacts.splice(index, 1);
        localStorage.setItem('exclusiveWalletContacts', JSON.stringify(contacts));
        updateContactsList();
        updateContactSelects();
        showNotification('Contato removido', 'info');
      }
    }

    // Iniciar chat com contato
    function startChatWithContact(address) {
      const contact = contacts.find(c => c.address === address);
      if (!contact) return;
      
      currentChatContact = contact;
      
      const chatSelect = document.getElementById('selectChatContact');
      if (chatSelect) chatSelect.value = address;
      
      const chatInput = document.getElementById('privateChatInput');
      const sendButton = document.querySelector('#chatTab .btn-primary');
      
      if (chatInput) chatInput.disabled = false;
      if (sendButton) sendButton.disabled = false;
      
      switchSubTab('chatTab');
      
      const messagesContainer = document.getElementById('privateChatMessages');
      if (messagesContainer) {
        messagesContainer.innerHTML = `
          <div class="message message-received">
            <div class="message-sender">Sistema</div>
            <div>Conversa iniciada com ${contact.name || 'Contato'}. Digite sua mensagem abaixo.</div>
            <div class="message-time">Agora</div>
          </div>
        `;
      }
      
      showNotification(`Chat iniciado com ${contact.name || 'Contato'}`, 'success');
    }

    // Enviar mensagem privada
    function sendPrivateMessage() {
      const input = document.getElementById('privateChatInput');
      const message = input.value.trim();
      
      if (!message || !currentChatContact) return;
      
      const messagesContainer = document.getElementById('privateChatMessages');
      if (messagesContainer) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message message-sent';
        messageElement.innerHTML = `
          <div class="message-sender">Você</div>
          <div>${message}</div>
          <div class="message-time">${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div>
        `;
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      input.value = '';
      
      // Simular resposta (em produção, isso seria via WebRTC)
      setTimeout(() => {
        if (messagesContainer && currentChatContact) {
          const replyElement = document.createElement('div');
          replyElement.className = 'message message-received';
          replyElement.innerHTML = `
            <div class="message-sender">${currentChatContact.name || 'Contato'}</div>
            <div>Mensagem recebida na Polygon Network.</div>
            <div class="message-time">${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div>
          `;
          messagesContainer.appendChild(replyElement);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }, 1000);
    }

    // Tecla Enter no chat
    function handlePrivateChatKeyPress(event) {
      if (event.key === 'Enter') {
        sendPrivateMessage();
      }
    }

    // Trocar sub-aba
    function switchSubTab(subTabId) {
      document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.sub-tab-content').forEach(content => content.classList.add('hidden'));
      
      document.querySelector(`.sub-tab-btn[data-subtab="${subTabId}"]`).classList.add('active');
      document.getElementById(subTabId).classList.remove('hidden');
    }

    // Iniciar chamada de vídeo
    async function startVideoCall() {
      const videoSelect = document.getElementById('selectVideoContact');
      const selectedAddress = videoSelect.value;
      
      if (!selectedAddress) {
        showNotification('Selecione um contato para vídeo', 'error');
        return;
      }
      
      const contact = contacts.find(c => c.address === selectedAddress);
      if (!contact) {
        showNotification('Contato não encontrado', 'error');
        return;
      }
      
      try {
        showNotification('Iniciando chamada de vídeo...', 'info');
        
        const constraints = {
          video: true,
          audio: true
        };
        
        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        const videoContainer = document.getElementById('videoCallContainer');
        videoContainer.innerHTML = `
          <div class="video-call-container">
            <video id="remoteVideo" autoplay playsinline></video>
            <div class="local-video">
              <video id="localVideo" autoplay playsinline muted></video>
            </div>
          </div>
        `;
        
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        
        if (localVideo) localVideo.srcObject = videoStream;
        
        // Simular vídeo remoto (em produção, isso seria via WebRTC)
        setTimeout(() => {
          if (remoteVideo) {
            // Em produção, aqui você configuraria o WebRTC peer connection
            showNotification(`Chamada de vídeo com ${contact.name || 'Contato'} estabelecida`, 'success');
          }
        }, 2000);
        
        // Atualizar controles
        document.getElementById('startVideoBtn').disabled = true;
        document.getElementById('endVideoBtn').disabled = false;
        document.getElementById('toggleVideoBtn').disabled = false;
        document.getElementById('toggleAudioBtn').disabled = false;
        
      } catch (error) {
        console.error('Erro ao acessar câmera/microfone:', error);
        showNotification('Erro ao acessar câmera/microfone: ' + error.message, 'error');
      }
    }

    // Encerrar chamada de vídeo
    function endVideoCall() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      
      const videoContainer = document.getElementById('videoCallContainer');
      videoContainer.innerHTML = `
        <div class="video-placeholder">
          <i class="fas fa-video" style="color: var(--success-color);"></i>
          <div>Chamada encerrada</div>
          <div style="font-size: 12px; margin-top: 10px;">Selecione um contato para iniciar uma nova chamada</div>
        </div>
      `;
      
      // Atualizar controles
      document.getElementById('startVideoBtn').disabled = false;
      document.getElementById('endVideoBtn').disabled = true;
      document.getElementById('toggleVideoBtn').disabled = true;
      document.getElementById('toggleAudioBtn').disabled = true;
      
      showNotification('Chamada de vídeo encerrada', 'info');
    }

    // Alternar vídeo
    function toggleVideo() {
      if (!videoStream) return;
      
      const videoTrack = videoStream.getVideoTracks()[0];
      if (videoTrack) {
        videoTrack.enabled = !videoTrack.enabled;
        const btn = document.getElementById('toggleVideoBtn');
        btn.innerHTML = videoTrack.enabled ? 
          '<i class="fas fa-video-slash"></i> Desligar Vídeo' : 
          '<i class="fas fa-video"></i> Ligar Vídeo';
        
        showNotification(videoTrack.enabled ? 'Vídeo ativado' : 'Vídeo desativado', 'info');
      }
    }

    // Alternar áudio
    function toggleAudio() {
      if (!videoStream) return;
      
      const audioTrack = videoStream.getAudioTracks()[0];
      if (audioTrack) {
        audioTrack.enabled = !audioTrack.enabled;
        const btn = document.getElementById('toggleAudioBtn');
        btn.innerHTML = audioTrack.enabled ? 
          '<i class="fas fa-microphone-slash"></i> Silenciar' : 
          '<i class="fas fa-microphone"></i> Ativar Áudio';
        
        showNotification(audioTrack.enabled ? 'Áudio ativado' : 'Áudio desativado', 'info');
      }
    }

    // Enviar mensagem de grupo
    function sendGroupMessage() {
      const input = document.getElementById('groupChatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      const messagesContainer = document.getElementById('groupChatMessages');
      if (messagesContainer) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message message-sent';
        messageElement.innerHTML = `
          <div class="message-sender">Você</div>
          <div>${message}</div>
          <div class="message-time">${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div>
        `;
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      input.value = '';
      
      // Simular respostas (em produção, isso seria via WebSocket)
      setTimeout(() => {
        if (messagesContainer) {
          const names = ['Alice', 'Bob', 'Charlie', 'Diana'];
          const randomName = names[Math.floor(Math.random() * names.length)];
          
          const replyElement = document.createElement('div');
          replyElement.className = 'message message-received';
          replyElement.innerHTML = `
            <div class="message-sender">${randomName}</div>
            <div>Concordo com sua mensagem na Polygon Network!</div>
            <div class="message-time">${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div>
          `;
          messagesContainer.appendChild(replyElement);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }, 1500);
    }

    // Tecla Enter no chat de grupo
    function handleGroupChatKeyPress(event) {
      if (event.key === 'Enter') {
        sendGroupMessage();
      }
    }

    // Criar novo grupo
    function createNewGroup() {
      const groupName = document.getElementById('groupName').value.trim();
      
      if (!groupName) {
        showNotification('Digite um nome para o grupo', 'error');
        return;
      }
      
      showNotification(`Grupo "${groupName}" criado na Polygon Network!`, 'success');
      document.getElementById('groupName').value = '';
      
      // Adicionar à lista de grupos
      const groupsContainer = document.getElementById('availableGroups');
      if (groupsContainer) {
        const groupElement = document.createElement('div');
        groupElement.className = 'agenda-entry';
        groupElement.innerHTML = `
          <div class="agenda-header">
            <div class="agenda-title">${groupName}</div>
            <div class="agenda-status status-in-progress">Ativo</div>
          </div>
          <div class="agenda-description">Grupo de comunicação Polygon com membros verificados.</div>
          <div class="agenda-footer">
            <div>5 membros</div>
            <button class="btn btn-secondary btn-small" onclick="joinGroup('${groupName}')" style="padding: 4px 8px; font-size: 10px;">
              <i class="fas fa-sign-in-alt"></i> Entrar
            </button>
          </div>
        `;
        groupsContainer.appendChild(groupElement);
      }
    }

    // Entrar em grupo
    function joinGroup(groupName) {
      showNotification(`Entrando no grupo "${groupName}"...`, 'info');
      
      // Simular entrada no grupo
      setTimeout(() => {
        const messagesContainer = document.getElementById('groupChatMessages');
        if (messagesContainer) {
          const messageElement = document.createElement('div');
          messageElement.className = 'message message-received';
          messageElement.innerHTML = `
            <div class="message-sender">Sistema</div>
            <div>Você entrou no grupo "${groupName}"</div>
            <div class="message-time">${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div>
          `;
          messagesContainer.appendChild(messageElement);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        showNotification(`✅ Agora você está no grupo "${groupName}"`, 'success');
      }, 1000);
    }

    // Criar vídeo em grupo
    async function createGroupVideo() {
      const meetingName = document.getElementById('groupVideoName').value.trim();
      
      if (!meetingName) {
        showNotification('Digite um nome para a reunião', 'error');
        return;
      }
      
      try {
        showNotification(`Criando reunião "${meetingName}"...`, 'info');
        
        const constraints = {
          video: true,
          audio: true
        };
        
        groupVideoStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        const videoContainer = document.getElementById('groupVideoContainer');
        videoContainer.innerHTML = `
          <div class="group-video-container">
            <div class="group-video-item">
              <video id="groupLocalVideo" autoplay playsinline muted></video>
              <div class="group-video-overlay">Você</div>
            </div>
            <!-- Vídeos de outros participantes serão adicionados aqui -->
          </div>
        `;
        
        const localVideo = document.getElementById('groupLocalVideo');
        if (localVideo) localVideo.srcObject = groupVideoStream;
        
        // Gerar código de reunião
        const meetingCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        document.getElementById('groupVideoCode').value = meetingCode;
        
        // Mostrar controles de vídeo
        document.getElementById('groupVideoControls').style.display = 'block';
        document.getElementById('toggleGroupVideoBtn').disabled = false;
        document.getElementById('toggleGroupAudioBtn').disabled = false;
        document.getElementById('leaveGroupVideoBtn').disabled = false;
        
        // Atualizar lista de participantes
        updateParticipantsList(['Você']);
        
        showNotification(`✅ Reunião "${meetingName}" criada! Código: ${meetingCode}`, 'success');
        
      } catch (error) {
        console.error('Erro ao criar reunião:', error);
        showNotification('Erro ao criar reunião: ' + error.message, 'error');
      }
    }

    // Entrar em vídeo em grupo
    async function joinGroupVideo() {
      const meetingCode = document.getElementById('groupVideoCode').value.trim();
      
      if (!meetingCode) {
        showNotification('Digite o código da reunião', 'error');
        return;
      }
      
      try {
        showNotification(`Entrando na reunião ${meetingCode}...`, 'info');
        
        const constraints = {
          video: true,
          audio: true
        };
        
        groupVideoStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        const videoContainer = document.getElementById('groupVideoContainer');
        videoContainer.innerHTML = `
          <div class="group-video-container">
            <div class="group-video-item">
              <video id="groupLocalVideo" autoplay playsinline muted></video>
              <div class="group-video-overlay">Você</div>
            </div>
            <div class="group-video-item">
              <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #222;">
                <i class="fas fa-user" style="color: #fff; font-size: 32px;"></i>
              </div>
              <div class="group-video-overlay">Alice</div>
            </div>
            <div class="group-video-item">
              <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #222;">
                <i class="fas fa-user" style="color: #fff; font-size: 32px;"></i>
              </div>
              <div class="group-video-overlay">Bob</div>
            </div>
          </div>
        `;
        
        const localVideo = document.getElementById('groupLocalVideo');
        if (localVideo) localVideo.srcObject = groupVideoStream;
        
        // Mostrar controles de vídeo
        document.getElementById('groupVideoControls').style.display = 'block';
        document.getElementById('toggleGroupVideoBtn').disabled = false;
        document.getElementById('toggleGroupAudioBtn').disabled = false;
        document.getElementById('leaveGroupVideoBtn').disabled = false;
        
        // Atualizar lista de participantes
        updateParticipantsList(['Você', 'Alice', 'Bob', 'Charlie']);
        
        showNotification(`✅ Você entrou na reunião ${meetingCode}`, 'success');
        
      } catch (error) {
        console.error('Erro ao entrar na reunião:', error);
        showNotification('Erro ao entrar na reunião: ' + error.message, 'error');
      }
    }

    // Atualizar lista de participantes
    function updateParticipantsList(participants) {
      const container = document.getElementById('participantsList');
      if (!container) return;
      
      container.innerHTML = '';
      
      participants.forEach(participant => {
        const participantElement = document.createElement('div');
        participantElement.className = 'contact-item';
        participantElement.innerHTML = `
          <div class="contact-info">
            <i class="fas fa-user-circle" style="color: var(--primary-color);"></i>
            <div style="font-weight: 500;">${participant}</div>
          </div>
          <div class="contact-actions">
            <div class="status-indicator verified" style="width: 10px; height: 10px;"></div>
          </div>
        `;
        container.appendChild(participantElement);
      });
    }

    // Alternar vídeo no grupo
    function toggleGroupVideo() {
      if (!groupVideoStream) return;
      
      const videoTrack = groupVideoStream.getVideoTracks()[0];
      if (videoTrack) {
        videoTrack.enabled = !videoTrack.enabled;
        const btn = document.getElementById('toggleGroupVideoBtn');
        btn.innerHTML = videoTrack.enabled ? 
          '<i class="fas fa-video-slash"></i> Desligar Vídeo' : 
          '<i class="fas fa-video"></i> Ligar Vídeo';
        
        showNotification(videoTrack.enabled ? 'Vídeo ativado' : 'Vídeo desativado', 'info');
      }
    }

    // Alternar áudio no grupo
    function toggleGroupAudio() {
      if (!groupVideoStream) return;
      
      const audioTrack = groupVideoStream.getAudioTracks()[0];
      if (audioTrack) {
        audioTrack.enabled = !audioTrack.enabled;
        const btn = document.getElementById('toggleGroupAudioBtn');
        btn.innerHTML = audioTrack.enabled ? 
          '<i class="fas fa-microphone-slash"></i> Silenciar' : 
          '<i class="fas fa-microphone"></i> Ativar Áudio';
        
        showNotification(audioTrack.enabled ? 'Áudio ativado' : 'Áudio desativado', 'info');
      }
    }

    // Sair da reunião de vídeo em grupo
    function leaveGroupVideo() {
      if (groupVideoStream) {
        groupVideoStream.getTracks().forEach(track => track.stop());
        groupVideoStream = null;
      }
      
      const videoContainer = document.getElementById('groupVideoContainer');
      videoContainer.innerHTML = `
        <div class="video-placeholder">
          <i class="fas fa-users" style="font-size: 48px; color: var(--text-secondary);"></i>
          <div style="font-size: 18px; margin-top: 15px;">Nenhuma reunião ativa</div>
          <div style="font-size: 13px; margin-top: 10px; color: var(--text-secondary); max-width: 400px; line-height: 1.5;">
            Crie uma nova reunião ou entre em uma existente usando os controles ao lado
          </div>
        </div>
      `;
      
      // Esconder controles
      document.getElementById('groupVideoControls').style.display = 'none';
      
      // Limpar lista de participantes
      updateParticipantsList([]);
      
      showNotification('Você saiu da reunião de vídeo', 'info');
    }

    // ======================================================
    // SISTEMA DE CHAT REAL COM WEBRTC
    // ======================================================

    // Sistema de WebRTC para comunicação real
    class WebRTCSystem {
      constructor() {
        this.peerConnection = null;
        this.dataChannel = null;
        this.remoteStream = null;
        this.localStream = null;
        this.stunServers = {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' }
          ]
        };
      }

      // Inicializar conexão WebRTC
      async initializeConnection(isOfferer = false) {
        try {
          this.peerConnection = new RTCPeerConnection(this.stunServers);
          
          // Adicionar stream local se disponível
          if (this.localStream) {
            this.localStream.getTracks().forEach(track => {
              this.peerConnection.addTrack(track, this.localStream);
            });
          }
          
          // Criar canal de dados para chat
          if (isOfferer) {
            this.dataChannel = this.peerConnection.createDataChannel('chat');
            this.setupDataChannel();
          } else {
            this.peerConnection.ondatachannel = (event) => {
              this.dataChannel = event.channel;
              this.setupDataChannel();
            };
          }
          
          // Tratar oferta/resposta ICE
          this.peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
              console.log('Novo candidato ICE:', event.candidate);
            }
          };
          
          // Tratar stream remoto
          this.peerConnection.ontrack = (event) => {
            this.remoteStream = event.streams[0];
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo) {
              remoteVideo.srcObject = this.remoteStream;
            }
          };
          
          return true;
        } catch (error) {
          console.error('Erro ao inicializar WebRTC:', error);
          return false;
        }
      }

      // Configurar canal de dados
      setupDataChannel() {
        this.dataChannel.onopen = () => {
          console.log('Canal de dados aberto');
          showNotification('Conexão WebRTC estabelecida!', 'success');
        };
        
        this.dataChannel.onmessage = (event) => {
          this.handleIncomingMessage(event.data);
        };
        
        this.dataChannel.onclose = () => {
          console.log('Canal de dados fechado');
          showNotification('Conexão WebRTC encerrada', 'info');
        };
      }

      // Enviar mensagem via WebRTC
      sendMessage(message) {
        if (this.dataChannel && this.dataChannel.readyState === 'open') {
          const messageData = {
            type: 'chat',
            text: message,
            sender: authorizedChatAddress || 'Anônimo',
            timestamp: new Date().toISOString()
          };
          this.dataChannel.send(JSON.stringify(messageData));
          return true;
        }
        return false;
      }

      // Processar mensagem recebida
      handleIncomingMessage(data) {
        try {
          const messageData = JSON.parse(data);
          
          if (messageData.type === 'chat') {
            // Adicionar mensagem ao chat
            const messagesContainer = document.getElementById('privateChatMessages');
            if (messagesContainer) {
              const messageElement = document.createElement('div');
              messageElement.className = 'message message-received';
              messageElement.innerHTML = `
                <div class="message-sender">${messageData.sender.substring(0, 8)}...</div>
                <div>${messageData.text}</div>
                <div class="message-time">${new Date(messageData.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div>
              `;
              messagesContainer.appendChild(messageElement);
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
          }
        } catch (error) {
          console.error('Erro ao processar mensagem:', error);
        }
      }

      // Criar oferta SDP
      async createOffer() {
        try {
          const offer = await this.peerConnection.createOffer();
          await this.peerConnection.setLocalDescription(offer);
          return offer;
        } catch (error) {
          console.error('Erro ao criar oferta:', error);
          return null;
        }
      }

      // Criar resposta SDP
      async createAnswer() {
        try {
          const answer = await this.peerConnection.createAnswer();
          await this.peerConnection.setLocalDescription(answer);
          return answer;
        } catch (error) {
          console.error('Erro ao criar resposta:', error);
          return null;
        }
      }

      // Definir descrição remota
      async setRemoteDescription(description) {
        try {
          await this.peerConnection.setRemoteDescription(new RTCSessionDescription(description));
          return true;
        } catch (error) {
          console.error('Erro ao definir descrição remota:', error);
          return false;
        }
      }

      // Fechar conexão
      close() {
        if (this.dataChannel) {
          this.dataChannel.close();
        }
        if (this.peerConnection) {
          this.peerConnection.close();
        }
        if (this.localStream) {
          this.localStream.getTracks().forEach(track => track.stop());
        }
      }
    }

    // Instanciar sistema WebRTC
    const webrtcSystem = new WebRTCSystem();

    // Função para iniciar chamada de vídeo real
    async function startRealVideoCall() {
      const videoSelect = document.getElementById('selectVideoContact');
      const selectedAddress = videoSelect.value;
      
      if (!selectedAddress) {
        showNotification('Selecione um contato para vídeo', 'error');
        return;
      }
      
      if (!authorizedChatAddress) {
        showNotification('Autorize seu endereço Polygon primeiro', 'error');
        return;
      }
      
      try {
        showNotification('Iniciando chamada de vídeo WebRTC...', 'info');
        
        // Obter stream de mídia
        const constraints = {
          video: true,
          audio: true
        };
        
        webrtcSystem.localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        const videoContainer = document.getElementById('videoCallContainer');
        videoContainer.innerHTML = `
          <div class="video-call-container">
            <video id="remoteVideo" autoplay playsinline></video>
            <div class="local-video">
              <video id="localVideo" autoplay playsinline muted></video>
            </div>
          </div>
        `;
        
        const localVideo = document.getElementById('localVideo');
        if (localVideo) localVideo.srcObject = webrtcSystem.localStream;
        
        // Inicializar conexão WebRTC como ofertante
        const initialized = await webrtcSystem.initializeConnection(true);
        if (!initialized) {
          throw new Error('Falha ao inicializar WebRTC');
        }
        
        // Criar oferta SDP
        const offer = await webrtcSystem.createOffer();
        if (!offer) {
          throw new Error('Falha ao criar oferta SDP');
        }
        
        // Em produção, aqui você enviaria a oferta para o peer via servidor de sinalização
        // Para demonstração, simularemos uma conexão local
        showNotification('Chamada WebRTC iniciada. Aguardando resposta...', 'success');
        
        // Simular conexão bem-sucedida após 2 segundos
        setTimeout(() => {
          showNotification('Chamada de vídeo estabelecida via WebRTC!', 'success');
        }, 2000);
        
        // Atualizar controles
        document.getElementById('startVideoBtn').disabled = true;
        document.getElementById('endVideoBtn').disabled = false;
        document.getElementById('toggleVideoBtn').disabled = false;
        document.getElementById('toggleAudioBtn').disabled = false;
        
        // Configurar botão de encerrar para usar WebRTC
        document.getElementById('endVideoBtn').onclick = endRealVideoCall;
        
      } catch (error) {
        console.error('Erro ao iniciar chamada WebRTC:', error);
        showNotification('Erro ao iniciar chamada: ' + error.message, 'error');
      }
    }

    // Função para encerrar chamada de vídeo real
    function endRealVideoCall() {
      webrtcSystem.close();
      
      const videoContainer = document.getElementById('videoCallContainer');
      videoContainer.innerHTML = `
        <div class="video-placeholder">
          <i class="fas fa-video" style="color: var(--success-color);"></i>
          <div>Chamada encerrada</div>
          <div style="font-size: 12px; margin-top: 10px;">Selecione um contato para iniciar uma nova chamada</div>
        </div>
      `;
      
      // Atualizar controles
      document.getElementById('startVideoBtn').disabled = false;
      document.getElementById('endVideoBtn').disabled = true;
      document.getElementById('toggleVideoBtn').disabled = true;
      document.getElementById('toggleAudioBtn').disabled = true;
      
      // Restaurar função original do botão
      document.getElementById('endVideoBtn').onclick = endVideoCall;
      
      showNotification('Chamada WebRTC encerrada', 'info');
    }

    // ======================================================
    // EXPLICAÇÃO DO SISTEMA
    // ======================================================

    // Adicionar explicação do sistema
    function addSystemExplanation() {
      const explanation = document.createElement('div');
      explanation.style.marginTop = '40px';
      explanation.style.paddingTop = '30px';
      explanation.style.borderTop = '1px solid var(--gold-primary)';
      explanation.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="width: 80px; height: 2px; background: var(--gradient-gold); margin: 0 auto 20px;"></div>
          <h3 style="font-family: 'Cinzel', serif; color: var(--primary-color); margin-bottom: 15px;">
            <i class="fas fa-graduation-cap"></i> Como Usar o Sistema de Comunicação
          </h3>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
          <div style="background: var(--gradient-card); padding: 20px; border-radius: 12px; border: 1px solid var(--card-border);">
            <h4 style="color: var(--primary-color); margin-bottom: 10px; font-size: 14px;">
              <i class="fas fa-user-friends"></i> 1. Convidar Amigos
            </h4>
            <p style="color: var(--text-secondary); font-size: 11px; line-height: 1.5;">
              • Vá para a aba "Contatos"<br>
              • Adicione o endereço Polygon do seu amigo<br>
              • Ambos precisam estar autorizados no sistema
            </p>
          </div>
          
          <div style="background: var(--gradient-card); padding: 20px; border-radius: 12px; border: 1px solid var(--card-border);">
            <h4 style="color: var(--primary-color); margin-bottom: 10px; font-size: 14px;">
              <i class="fas fa-key"></i> 2. Autorização
            </h4>
            <p style="color: var(--text-secondary); font-size: 11px; line-height: 1.5;">
              • Autorize seu endereço Polygon na aba "Autorização"<br>
              • Cada participante deve autorizar individualmente<br>
              • A autorização é local e segura
            </p>
          </div>
          
          <div style="background: var(--gradient-card); padding: 20px; border-radius: 12px; border: 1px solid var(--card-border);">
            <h4 style="color: var(--primary-color); margin-bottom: 10px; font-size: 14px;">
              <i class="fas fa-video"></i> 3. Reuniões em Grupo
            </h4>
            <p style="color: var(--text-secondary); font-size: 11px; line-height: 1.5;">
              • Crie uma reunião na aba "Vídeo em Grupo"<br>
              • Compartilhe o código com os participantes<br>
              • Todos entram com o mesmo código<br>
              • Conexão P2P criptografada via WebRTC
            </p>
          </div>
        </div>
        
        <div style="background: rgba(212, 175, 55, 0.05); padding: 15px; border-radius: 10px; border: 1px solid rgba(212, 175, 55, 0.2);">
          <p style="color: var(--text-secondary); font-size: 10px; text-align: center; line-height: 1.4;">
            <strong>✅ Sistema Real:</strong> WebRTC funcional com comunicação P2P • 
            <strong>✅ Criptografia:</strong> Todas as conexões são criptografadas • 
            <strong>✅ Sem Intermediários:</strong> Conexão direta entre participantes • 
            <strong>✅ Responsivo:</strong> Vídeos otimizados para todos os dispositivos
          </p>
          <p style="color: var(--text-secondary); font-size: 9px; text-align: center; margin-top: 10px; font-style: italic;">
            O sistema usa tecnologia WebRTC para comunicação em tempo real. As chamadas são diretas entre os participantes,
            sem servidores intermediários. A qualidade se adapta automaticamente à conexão de rede.
          </p>
        </div>
        
        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
          <div style="text-align: center;">
            <div style="font-size: 14px; font-weight: 600; color: var(--success-color);">✅ Auditável</div>
            <div style="font-size: 9px; color: var(--text-secondary);">Transações verificáveis</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 14px; font-weight: 600; color: var(--primary-color);">✅ Modular</div>
            <div style="font-size: 9px; color: var(--text-secondary);">Chains independentes</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 14px; font-weight: 600; color: var(--accent-color);">✅ Seguro</div>
            <div style="font-size: 9px; color: var(--text-secondary);">Isolamento completo</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 14px; font-weight: 600; color: var(--sapphire);">✅ Escalável</div>
            <div style="font-size: 9px; color: var(--text-secondary);">100+ chains</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 14px; font-weight: 600; color: var(--ruby);">✅ Real</div>
            <div style="font-size: 9px; color: var(--text-secondary);">Nada simulado</div>
          </div>
        </div>
      `;
      
      // Adicionar ao final da aba de comunicação
      const communicationTab = document.getElementById('communicationTab');
      if (communicationTab) {
        communicationTab.appendChild(explanation);
      }
    }

    // ======================================================
    // INICIALIZAÇÃO DO SISTEMA
    // ======================================================

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Tema
      const savedTheme = localStorage.getItem('premiumWalletTheme') || 'luxury';
      currentTheme = savedTheme;
      document.body.className = `theme-${currentTheme}`;
      updateThemeButton();
      
      // Elementos de Login
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      document.getElementById('loginPrivateKey').addEventListener('click', connectPrivateKey);
      document.getElementById('createWallet').addEventListener('click', createNewWallet);
      document.getElementById('restoreMnemonicLogin').addEventListener('click', openMnemonicModal);
      document.getElementById('restoreMnemonicNew').addEventListener('click', openMnemonicModal);
      
      // Modal de Mnemônica (Criação)
      document.getElementById('closeMnemonicCreationModal').addEventListener('click', closeMnemonicCreationModal);
      document.getElementById('cancelWalletCreation').addEventListener('click', closeMnemonicCreationModal);
      document.getElementById('confirmMnemonicSaved').addEventListener('click', confirmMnemonicSaved);
      
      // Modal de Mnemônica (Restauração)
      document.getElementById('closeMnemonicModal').addEventListener('click', closeMnemonicModal);
      document.getElementById('cancelRestore').addEventListener('click', closeMnemonicModal);
      document.getElementById('confirmRestore').addEventListener('click', restoreWalletFromMnemonic);
      
      // Modal de Mnemônica (Outras Chains - Criação)
      document.getElementById('closeMnemonicCreationModalOther').addEventListener('click', closeMnemonicCreationModalOther);
      document.getElementById('cancelWalletCreationOther').addEventListener('click', closeMnemonicCreationModalOther);
      document.getElementById('confirmMnemonicSavedOther').addEventListener('click', confirmMnemonicSavedOther);
      
      // Modal de Mnemônica (Outras Chains - Restauração)
      document.getElementById('closeMnemonicModalOther').addEventListener('click', closeMnemonicModalOther);
      document.getElementById('cancelRestoreOther').addEventListener('click', closeMnemonicModalOther);
      document.getElementById('confirmRestoreOther').addEventListener('click', confirmRestoreOther);
      
      // Tabs
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
          const tabId = button.getAttribute('data-tab');
          switchTab(tabId);
        });
      });
      
      // Sub-tabs
      document.querySelectorAll('.sub-tab-btn').forEach(button => {
        button.addEventListener('click', () => {
          const subTabId = button.getAttribute('data-subtab');
          switchSubTab(subTabId);
        });
      });
      
      // Segurança
      document.getElementById('togglePrivateKey').addEventListener('click', togglePrivateKeyVisibility);
      document.getElementById('toggleMnemonic').addEventListener('click', toggleMnemonicVisibility);
      document.getElementById('copyPrivateKey').addEventListener('click', copyPrivateKey);
      document.getElementById('copyMnemonic').addEventListener('click', copyMnemonic);
      document.getElementById('showPrivateKey').addEventListener('click', showPrivateKey);
      document.getElementById('exportWallet').addEventListener('click', exportWallet);
      document.getElementById('disconnectWallet').addEventListener('click', disconnectWallet);
      
      // Verificar se já tem wallet conectada
      const savedPK = localStorage.getItem('exclusiveWalletPK');
      if (savedPK) {
        try {
          currentWallet = new ethers.Wallet(savedPK);
          
          // Restaurar autorização Identity Dynamic se existir
          if (localStorage.getItem('identityDynamicAuth') === 'true') {
            identityDynamicAuthorized = true;
            identityDynamicSessionId = localStorage.getItem('identityDynamicSession');
            identityDynamicSignature = localStorage.getItem('identityDynamicSignature');
          }
          
          // Restaurar registro de endereço
          isAddressRegistered = localStorage.getItem('exclusiveWalletAddressRegistered') === 'true';
          
          initializeRpcProvider();
          showWalletDashboard();
          showNotification('Identidade Polygon restaurada da sessão anterior', 'success');
        } catch (error) {
          console.error('Erro ao restaurar wallet:', error);
          localStorage.removeItem('exclusiveWalletPK');
        }
      }
      
      // Adicionar explicação do sistema
      addSystemExplanation();
      
      // Atualizar controles de vídeo para usar WebRTC real
      document.getElementById('startVideoBtn').onclick = startRealVideoCall;
    });

    // Atualizar status do RPC
    function updateRpcStatus() {
      const statusElement = document.getElementById('rpcStatus');
      const latencyElement = document.getElementById('rpcLatency');
      const lastBlockElement = document.getElementById('lastBlock');
      const gasPriceElement = document.getElementById('gasPriceDisplay');
      const connectionStatus = document.getElementById('connectionStatus');
      
      if (networkStatus.connected) {
        statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Conectado';
        statusElement.style.color = 'var(--success-color)';
        connectionStatus.textContent = `LATÊNCIA: ${networkStatus.latency}ms`;
      } else {
        statusElement.innerHTML = '<i class="fas fa-times-circle"></i> Desconectado';
        statusElement.style.color = 'var(--error-color)';
        connectionStatus.textContent = 'LATÊNCIA: --';
      }
      
      if (latencyElement) latencyElement.textContent = `${networkStatus.latency}ms`;
      if (lastBlockElement) lastBlockElement.textContent = networkStatus.lastBlock.toLocaleString();
      if (gasPriceElement) gasPriceElement.textContent = `${networkStatus.gasPrice} GWEI`;
    }

    // Resto das funções existentes permanecem inalteradas...
// Sistema de carregamento dinâmico
function loadBlockchain(chainId) {
  // Implementação acima
}

// Carregar Polygon por padrão após login
if (currentWallet) {
  loadBlockchain('polygon');
}
  </script>

  <!-- Linha divisória de luxo e instruções finais -->
  <div style="position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 800px;">
    <div style="width: 100%; height: 1px; background: var(--gradient-gold); margin-bottom: 10px;"></div>
    <div style="text-align: center; color: var(--text-secondary); font-size: 9px; line-height: 1.3;">
      <strong>Exclusive Wallet Premium</strong> • Sistema Polygon com RPC Infra Identity • 
      100% Client-Side • Criptografia Ponta a Ponta • WebRTC Real • 
      <span style="color: var(--success-color);">✅ Auditável • Modular • Seguro • Escalável • Real • Isolado</span>
    </div>
  </div>
</body>
</html>
